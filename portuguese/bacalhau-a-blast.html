<!--
  Language Blaster - Bacalhau A Bl√°st
  ¬© 2024-2026 kiddoland.co. All rights reserved.
  Unauthorized copying, modification, or distribution is prohibited.
  License: https://github.com/jwaglang/Language-Blaster-Public/blob/main/terms.html
-->

<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üêü BACALHAU √Ä BL√ÅST! üêü</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-pink: #ff3366;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --neon-green: #00ff64;
            --neon-orange: #ff6600;
            --deep-space: #0a1a2a;
            --pt-green: #00ff64;
            --pt-red: #ff3333;
            --pt-gold: #ffd700;
            --azulejo-blue: #1e90ff;
            --azulejo-dark: #1a3a6c;
        }

        body {
            background: var(--deep-space);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            touch-action: none;
        }

        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.1) 0px, rgba(0, 0, 0, 0.1) 1px, transparent 1px, transparent 2px);
        }

        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .bg-star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }
        }

        /* Shooting stars */
        .shooting-star {
            position: absolute;
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff);
            opacity: 0.5;
            transform: rotate(135deg);
            animation: shootingStar 1.2s linear forwards;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes shootingStar {
            0% {
                transform: rotate(135deg) translateX(0);
                opacity: 0.6;
            }

            70% {
                opacity: 0.4;
            }

            100% {
                transform: rotate(135deg) translateX(400px);
                opacity: 0;
            }
        }
        
        .kpop-shooting-star {
            position: absolute;
            font-size: 2rem;
            opacity: 0.9;
            transform: rotate(10deg);
            animation: kpopShoot 3s linear forwards;
            pointer-events: none;
            z-index: 1;
            filter: drop-shadow(0 0 10px #00ffff) drop-shadow(0 0 20px #1e90ff);
        }
        
        @keyframes kpopShoot {
            0% {
                transform: rotate(10deg) translateX(0) scale(1);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            80% {
                opacity: 0.9;
            }
            100% {
                transform: rotate(10deg) translateX(600px) scale(0.8);
                opacity: 0;
            }
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            height: 100vh;
            max-height: 700px;
            background: linear-gradient(180deg, var(--azulejo-dark) 0%, var(--deep-space) 50%, var(--azulejo-dark) 100%);
            border: 8px solid var(--pt-gold);
            position: relative;
            overflow: hidden;
            animation: borderPulse 10s ease-in-out infinite;
            cursor: crosshair;
        }

        @keyframes borderPulse {
            0%, 100% {
                box-shadow: 0 0 30px #ff66ff, 0 0 60px #ff66ff, 0 0 90px #ff33cc, inset 0 0 60px rgba(255, 102, 255, 0.15);
            }
            16% {
                box-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff, 0 0 90px #00cccc, inset 0 0 60px rgba(0, 255, 255, 0.15);
            }
            33% {
                box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700, 0 0 90px #ffaa00, inset 0 0 60px rgba(255, 215, 0, 0.15);
            }
            50% {
                box-shadow: 0 0 30px #00cc00, 0 0 60px #00cc00, 0 0 90px #009900, inset 0 0 60px rgba(0, 204, 0, 0.15);
            }
            66% {
                box-shadow: 0 0 30px #ff3333, 0 0 60px #ff3333, 0 0 90px #cc0000, inset 0 0 60px rgba(255, 51, 51, 0.15);
            }
            83% {
                box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700, 0 0 90px #ffaa00, inset 0 0 60px rgba(255, 215, 0, 0.15);
            }
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: radial-gradient(ellipse at center, var(--azulejo-blue) 0%, var(--deep-space) 70%);
            cursor: default;
        }

        .screen.hidden {
            display: none;
        }

        .game-title {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1rem, 3vw, 1.6rem);
            color: #ffffff;
            text-shadow: 0 0 10px var(--pt-gold), 0 0 20px var(--pt-gold), 0 0 40px #ffaa00, 3px 3px 0 var(--azulejo-dark);
            animation: titlePulse 1.5s infinite ease-in-out;
            text-align: center;
            letter-spacing: 1px;
            line-height: 1.4;
            padding: 10px 25px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .title-icon {
            filter: drop-shadow(0 0 8px var(--pt-green)) drop-shadow(0 0 15px var(--pt-red));
        }

        @keyframes titlePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .subtitle {
            font-size: clamp(0.5rem, 1.5vw, 0.8rem);
            color: var(--neon-cyan);
            margin-top: 15px;
            text-shadow: 0 0 10px var(--neon-cyan);
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            49% {
                opacity: 1;
            }

            50%,
            100% {
                opacity: 0.3;
            }
        }

        .level-select-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .level-select-label {
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            color: var(--neon-cyan);
        }

        .level-select {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            padding: 8px 12px;
            cursor: pointer;
        }

        .level-select:focus {
            outline: none;
            border-color: var(--neon-yellow);
            box-shadow: 0 0 10px var(--neon-yellow);
        }

        .level-select option {
            background: var(--azulejo-blue);
            color: var(--neon-cyan);
        }

        .btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.6rem, 2vw, 0.9rem);
            border: 4px solid var(--neon-cyan);
            color: #000;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn-green {
            background: linear-gradient(180deg, var(--pt-green) 0%, #00aa44 100%);
            box-shadow: 0 6px 0 #006622, 0 0 20px var(--pt-green);
            color: #001100;
        }

        .btn-gold {
            background: linear-gradient(180deg, #ffd700 0%, #cc9900 100%);
            box-shadow: 0 6px 0 #996600, 0 0 20px #ffd700;
            color: #331100;
        }

        .btn-cyan {
            background: linear-gradient(180deg, var(--neon-cyan) 0%, #0088aa 100%);
            box-shadow: 0 6px 0 #005566, 0 0 20px var(--neon-cyan);
        }

        .btn-red {
            background: linear-gradient(180deg, var(--pt-red) 0%, #cc0000 100%);
            box-shadow: 0 6px 0 #880000, 0 0 20px var(--pt-red);
            color: white;
        }

        .btn-orange {
            background: linear-gradient(180deg, var(--neon-orange) 0%, #aa4400 100%);
            box-shadow: 0 6px 0 #663300, 0 0 20px var(--neon-orange);
        }

        .btn-blue {
            background: linear-gradient(180deg, var(--azulejo-blue) 0%, #1060aa 100%);
            box-shadow: 0 6px 0 #0a3060, 0 0 20px var(--azulejo-blue);
            color: white;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(2px);
        }

        .btn:active {
            transform: translateY(6px);
        }

        /* Username Input */
        .username-input {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.6rem, 2vw, 1rem);
            padding: 15px 20px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            margin: 20px 0;
        }

        .username-input:focus {
            outline: none;
            border-color: var(--neon-yellow);
            box-shadow: 0 0 20px var(--neon-yellow);
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
            z-index: 50;
        }

        .hud-item {
            font-size: clamp(0.35rem, 1.1vw, 0.55rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        .hud-item.cyan {
            color: var(--pt-green);
            text-shadow: 0 0 10px var(--pt-green);
        }

        .lives-display {
            display: flex;
            gap: 3px;
        }

        .life-icon {
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            filter: drop-shadow(0 0 5px var(--azulejo-blue));
        }

        .pause-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.4rem, 1vw, 0.5rem);
            padding: 5px 10px;
            cursor: pointer;
        }

        .pause-btn:hover {
            background: rgba(0, 255, 255, 0.2);
        }

        /* Timer */
        .timer-sword {
            position: absolute;
            top: 50px;
            left: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 55;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 8px;
            border-radius: 6px;
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            transform: scale(0.7);
            transform-origin: top left;
        }

        .timer-sword .sword-icon {
            font-size: clamp(1.4rem, 3vw, 1.8rem);
            filter: drop-shadow(0 0 6px #ffd700);
        }

        .timer-sword .power-meter {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .timer-sword .power-label {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.3rem, 0.8vw, 0.35rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 5px var(--neon-cyan);
        }

        .timer-sword .power-bar {
            display: flex;
            gap: 2px;
        }

        .timer-sword .power-segment {
            width: clamp(8px, 2vw, 11px);
            height: clamp(14px, 3vw, 20px);
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .timer-sword .power-segment.active {
            background: linear-gradient(180deg, #ffd700 0%, #ffaa00 100%);
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        .timer-sword .power-segment.warning {
            background: linear-gradient(180deg, #ff8800 0%, #ff4400 100%);
            border-color: #ff6600;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.6);
        }

        .timer-sword .power-segment.critical {
            background: linear-gradient(180deg, #ff0000 0%, #aa0000 100%);
            border-color: #ff0000;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.8);
            animation: segmentPulse 0.3s infinite;
        }

        @keyframes segmentPulse {
            0%, 100% { opacity: 1; transform: scaleY(1); }
            50% { opacity: 0.6; transform: scaleY(0.95); }
        }

        .timer-sword .power-time {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.5rem, 1.2vw, 0.65rem);
            color: #ffd700;
            text-shadow: 0 0 8px #ffd700;
            text-align: right;
            min-width: 35px;
        }

        .timer-sword .power-time.warning {
            color: var(--neon-orange);
            text-shadow: 0 0 8px var(--neon-orange);
        }

        .timer-sword .power-time.critical {
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000;
            animation: timePulse 0.3s infinite;
        }

        @keyframes timePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .penalty-indicator {
            position: absolute;
            top: 130px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 55;
        }

        .penalty-badge {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.3rem, 0.9vw, 0.4rem);
            padding: 6px 10px;
            border-radius: 4px;
            animation: badgeGlow 1.5s infinite;
        }

        .penalty-badge.danger-mode {
            background: rgba(255, 100, 0, 0.3);
            border: 2px solid #ff6600;
            color: #ffaa00;
            text-shadow: 0 0 5px #ff6600;
        }

        .penalty-badge.panic-mode {
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #ff0000;
            color: #ff4444;
            text-shadow: 0 0 5px #ff0000;
        }

        @keyframes badgeGlow {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; box-shadow: 0 0 15px currentColor; }
        }

        .timeout-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            animation: flashOut 0.6s forwards;
        }

        .timeout-flash.danger {
            background: rgba(255, 100, 0, 0.5);
        }

        .timeout-flash.panic {
            background: rgba(255, 0, 0, 0.5);
        }

        .timeout-flash.death {
            background: rgba(100, 0, 0, 0.7);
        }

        @keyframes flashOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        .mode-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.8rem, 3vw, 1.4rem);
            text-align: center;
            z-index: 200;
            white-space: nowrap;
            animation: modeAnnounce 2.5s forwards;
            padding: 15px 25px;
            border-radius: 8px;
        }

        .mode-announce.danger {
            color: #ffcc00;
            text-shadow: 0 0 10px #ff6600, 0 0 20px #ff6600, 3px 3px 0 #000;
            background: rgba(255, 100, 0, 0.2);
            border: 3px solid #ff6600;
            box-shadow: 0 0 30px rgba(255, 100, 0, 0.5);
        }

        .mode-announce.panic {
            color: #ff4444;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 3px 3px 0 #000;
            background: rgba(255, 0, 0, 0.2);
            border: 3px solid #ff0000;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }

        .mode-announce.death {
            color: #ffffff;
            text-shadow: 0 0 10px #ff0000, 0 0 30px #ff0000, 3px 3px 0 #000;
            background: rgba(100, 0, 0, 0.4);
            border: 3px solid #ff0000;
        }

        .mode-announce .mode-subtitle {
            font-size: 0.6em;
            margin-top: 8px;
            opacity: 0.9;
        }

        @keyframes modeAnnounce {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            15% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            25% { transform: translate(-50%, -50%) scale(1); }
            75% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        .round-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1.2rem, 4vw, 2rem);
            text-align: center;
            z-index: 200;
            white-space: nowrap;
            animation: roundAnnounce 2s forwards;
            padding: 20px 30px;
            border-radius: 10px;
            color: #00ffff;
            text-shadow: 0 0 15px #00ffff, 0 0 30px #1e90ff, 3px 3px 0 #000;
            background: rgba(30, 144, 255, 0.2);
            border: 3px solid #1e90ff;
            box-shadow: 0 0 40px rgba(30, 144, 255, 0.5);
        }

        .round-announce .round-subtitle {
            font-size: 0.5em;
            margin-top: 10px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        @keyframes roundAnnounce {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        /* Target Area */
        .target-area {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 40;
        }

        .target-label {
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 5px var(--neon-cyan);
            margin-bottom: 5px;
        }

        .target-letter {
            font-family: 'VT323', 'Press Start 2P', monospace;
            font-size: clamp(2.1rem, 5.6vw, 3.1rem);
            color: #ffffff;
            text-shadow: 0 0 15px var(--azulejo-blue), 0 0 30px var(--azulejo-blue), 0 0 45px var(--neon-cyan);
            padding: 10px 20px;
            min-width: 120px;
            animation: targetGlow 0.5s infinite alternate;
            text-transform: none !important;
        }

        .target-letter.hidden-letter {
            color: transparent;
            text-shadow: none;
        }

        .target-letter.hidden-letter::after {
            content: '?';
            color: var(--pt-red);
            text-shadow: 0 0 20px var(--pt-red);
        }

        @keyframes targetGlow {
            0% {
                filter: brightness(1);
            }

            100% {
                filter: brightness(1.3);
            }
        }

        .speak-btn {
            margin-top: 8px;
            padding: 6px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.3rem, 0.8vw, 0.4rem);
            background: var(--neon-cyan);
            border: 2px solid var(--pt-gold);
            color: #001133;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        /* Game Area */
        .game-area {
            position: absolute;
            top: 150px;
            left: 0;
            width: 100%;
            height: calc(100% - 220px);
            overflow: hidden;
        }

        .floating-letter,
        .floating-word {
            position: absolute;
            font-family: 'VT323', 'Press Start 2P', monospace;
            font-size: clamp(2rem, 5.6vw, 2.8rem);
            user-select: none;
            pointer-events: auto;
            text-transform: none !important;
            cursor: help;
        }

        .floating-word {
            font-size: clamp(1.55rem, 4.2vw, 2.25rem);
            letter-spacing: 1px;
            text-transform: none !important;
        }

        /* Tooltip for translations */
        .floating-letter[data-meaning]::after,
        .floating-word[data-meaning]::after {
            content: attr(data-meaning);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 26, 42, 0.95);
            color: var(--neon-cyan);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-family: 'Press Start 2P', cursive;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 2px solid var(--azulejo-blue);
            z-index: 100;
        }

        .floating-letter:hover::after,
        .floating-word:hover::after {
            opacity: 1;
        }

        .floating-letter.hit,
        .floating-word.hit {
            animation: letterHit 0.3s ease-out forwards;
        }

        /* Gold Record (Challenge Item) */
        .meteorite {
            position: absolute;
            user-select: none;
            pointer-events: auto;
            cursor: crosshair;
            animation: recordSpin 1.5s linear infinite;
        }
        
        .meteorite.gold-record {
            filter: drop-shadow(0 0 15px #FFD700) drop-shadow(0 0 25px #DAA520);
        }
        
        .gold-record-icon {
            vertical-align: middle;
            filter: drop-shadow(0 0 10px #FFD700);
            animation: recordGlow 1s ease-in-out infinite alternate;
        }

        @keyframes recordSpin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        @keyframes recordGlow {
            0% { filter: drop-shadow(0 0 10px #FFD700); }
            100% { filter: drop-shadow(0 0 20px #FFD700) drop-shadow(0 0 30px #DAA520); }
        }

        /* Challenge Modal */
        .challenge-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 85;
            padding: 20px;
        }

        .challenge-modal.hidden {
            display: none;
        }

        .challenge-music-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-orange);
            color: var(--neon-orange);
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .challenge-music-toggle:hover {
            background: rgba(255, 102, 0, 0.2);
            transform: scale(1.1);
        }

        .challenge-music-toggle.muted {
            opacity: 0.5;
            border-style: dashed;
        }

        .challenge-title {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--neon-orange);
            text-shadow: 0 0 20px var(--neon-orange);
            margin-bottom: 20px;
            text-align: center;
        }

        .challenge-question {
            font-size: clamp(0.5rem, 1.5vw, 0.8rem);
            color: white;
            text-align: center;
            margin-bottom: 20px;
            max-width: 90%;
            line-height: 1.6;
        }

        .challenge-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            width: 90%;
            max-width: 400px;
        }

        .challenge-option {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .challenge-option:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }

        .challenge-option.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .challenge-option.wrong {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff4444;
            color: #ff4444;
        }

        .challenge-option.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .challenge-result {
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            margin-bottom: 15px;
            text-align: center;
        }

        .challenge-result.correct {
            color: var(--neon-green);
        }

        .challenge-result.wrong {
            color: #ff4444;
        }

        .challenge-result.hidden {
            display: none;
        }

        .challenge-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .double-down-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--neon-pink);
            text-align: center;
        }

        .double-down-text {
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            color: var(--neon-orange);
            margin-bottom: 15px;
        }

        /* Dictation Mode */
        .dictation-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 40;
            width: 90%;
            max-width: 500px;
        }

        .dictation-area.hidden {
            display: none;
        }

        .dictation-prompt {
            font-family: 'VT323', 'Press Start 2P', monospace;
            font-size: clamp(3rem, 10vw, 5rem);
            color: var(--neon-yellow);
            text-shadow: 0 0 20px var(--neon-yellow);
            margin-bottom: 30px;
            min-height: 1.2em;
        }

        .dictation-input {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'VT323', 'Press Start 2P', monospace;
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            padding: 15px 25px;
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .dictation-input:focus {
            outline: none;
            border-color: var(--neon-yellow);
            box-shadow: 0 0 20px var(--neon-yellow);
        }

        .dictation-hint {
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: var(--neon-pink);
            margin-bottom: 15px;
        }

        @keyframes letterHit {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Spaceship - K-pop Idol */
        .spaceship {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(45px, 8vw, 60px);
            height: clamp(55px, 10vw, 75px);
            filter: drop-shadow(0 0 15px var(--neon-pink)) drop-shadow(0 0 25px var(--neon-cyan));
            z-index: 30;
            pointer-events: none;
        }

        .spaceship.shooting {
            animation: shipRecoil 0.1s ease-out;
        }

        @keyframes shipRecoil {
            0% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(5px);
            }

            100% {
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Laser */
        .laser {
            position: absolute;
            width: 8px;
            height: 50px;
            background: linear-gradient(180deg, #ffffff, var(--neon-cyan), transparent);
            border-radius: 4px;
            box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--azulejo-blue);
            z-index: 25;
            pointer-events: none;
        }

        /* Explosion */
        .explosion {
            position: absolute;
            font-size: 2.5rem;
            animation: explode 0.5s ease-out forwards;
            z-index: 60;
            pointer-events: none;
        }

        @keyframes explode {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Feedback */
        .feedback {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1rem, 3vw, 1.5rem);
            text-align: center;
            z-index: 70;
            animation: feedbackPop 0.6s ease-out forwards;
            pointer-events: none;
            letter-spacing: 2px;
        }

        .feedback.great {
            color: #00ff64;
            text-shadow: 0 0 15px #00ff64, 0 0 30px #00ffff, 3px 3px 0 #004422;
        }

        .feedback.oops {
            color: #ff3333;
            text-shadow: 0 0 15px #ff3333, 0 0 30px #ff00ff, 3px 3px 0 #660000;
        }

        @keyframes feedbackPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            30% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }

            70% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* Stars */
        .stars-earned {
            margin: 20px 0;
            font-size: clamp(1.5rem, 5vw, 3rem);
        }

        .stars-earned .star {
            display: inline-block;
            animation: starPop 0.5s ease-out forwards;
            opacity: 0;
            filter: drop-shadow(0 0 10px var(--neon-yellow));
        }

        @keyframes starPop {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.3) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        /* Screen specific */
        .level-intro {
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            color: var(--neon-cyan);
            margin: 15px 0;
            text-align: center;
            max-width: 85%;
            line-height: 1.8;
        }

        .final-score {
            font-size: clamp(0.5rem, 1.5vw, 0.8rem);
            color: var(--neon-yellow);
            margin-top: 15px;
            text-shadow: 0 0 10px var(--neon-yellow);
        }

        .instructions {
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-cyan);
            border-radius: 10px;
            max-width: 85%;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            align-items: center;
        }

        .instructions .level-icon {
            font-size: clamp(0.5rem, 1.2vw, 0.7rem);
            text-align: center;
        }

        .instructions .level-text {
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: white;
            text-align: left;
        }

        .shoot-hint {
            position: absolute;
            bottom: 75px;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
            animation: blink 1s infinite;
            z-index: 35;
            pointer-events: none;
        }

        /* Scoreboard */
        .scoreboard {
            max-height: 200px;
            overflow-y: auto;
            width: 90%;
            max-width: 400px;
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-pink);
            border-radius: 8px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: white;
            border-bottom: 1px solid rgba(255, 0, 255, 0.3);
        }

        .score-row:last-child {
            border-bottom: none;
        }

        .score-row.header {
            color: var(--neon-yellow);
            font-weight: bold;
        }

        .score-row.current-user {
            color: var(--neon-green);
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .player-welcome {
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            color: var(--neon-green);
            margin: 10px 0;
        }

        .stats-container {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            width: 90%;
            max-width: 350px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.35rem, 1vw, 0.5rem);
            color: white;
            padding: 5px 0;
        }

        .stat-value {
            color: var(--neon-yellow);
        }

        /* Pause overlay */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 80;
        }

        .pause-overlay.hidden {
            display: none;
        }

        .pause-title {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(2rem, 6vw, 4rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            animation: titlePulse 1.5s infinite;
        }

        /* Music toggle */
        .audio-controls {
            position: absolute;
            top: 50px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 60;
        }

        .music-toggle, .playlist-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-size: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .music-toggle:hover, .playlist-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .playlist-btn {
            border-color: var(--pt-gold);
            color: var(--pt-gold);
        }

        .playlist-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .music-toggle.muted {
            opacity: 0.5;
            border-style: dashed;
        }

        /* Volume Sliders */
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 0;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-cyan);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            opacity: 0;
            transition: width 0.3s, opacity 0.3s;
        }

        .audio-controls:hover .volume-slider {
            width: 80px;
            opacity: 1;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--neon-cyan);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-cyan);
            transition: all 0.2s;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--neon-cyan);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .volume-slider:hover::-webkit-slider-thumb {
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        .volume-slider.challenge-volume {
            width: 0;
            border-color: var(--neon-orange);
        }

        .challenge-audio-controls:hover .volume-slider.challenge-volume {
            width: 70px;
            opacity: 1;
        }

        .volume-slider.challenge-volume::-webkit-slider-thumb {
            background: var(--neon-orange);
            box-shadow: 0 0 10px var(--neon-orange);
        }

        .volume-slider.challenge-volume::-moz-range-thumb {
            background: var(--neon-orange);
            box-shadow: 0 0 10px var(--neon-orange);
        }

        /* Challenge audio controls container */
        .challenge-audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .challenge-audio-controls .challenge-music-toggle {
            position: relative;
            top: auto;
            right: auto;
        }

        /* Playlist Menu */
        .playlist-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 26, 42, 0.98);
            border: 4px solid var(--pt-gold);
            border-radius: 15px;
            padding: 20px;
            z-index: 300;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
        }

        .playlist-menu.hidden {
            display: none;
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--azulejo-blue);
        }

        .playlist-header h3 {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            color: var(--pt-gold);
            text-shadow: 0 0 10px var(--pt-gold);
            margin: 0;
        }

        .playlist-close {
            background: none;
            border: 2px solid var(--neon-pink);
            color: var(--neon-pink);
            font-size: 1rem;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .playlist-close:hover {
            background: rgba(255, 0, 255, 0.2);
        }

        .playlist-section {
            margin-bottom: 15px;
        }

        .playlist-section h4 {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.35rem, 1vw, 0.45rem);
            color: var(--neon-cyan);
            margin-bottom: 10px;
        }

        .playlist-track {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(30, 144, 255, 0.1);
            border: 2px solid var(--azulejo-blue);
            border-radius: 8px;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.3rem, 0.8vw, 0.4rem);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .playlist-track:hover {
            background: rgba(30, 144, 255, 0.3);
            border-color: var(--neon-cyan);
        }

        .playlist-track.active {
            background: rgba(0, 255, 100, 0.2);
            border-color: var(--pt-green);
            color: var(--pt-green);
        }

        .playlist-track.playing::before {
            content: '‚ñ∂ ';
        }

        .playlist-info {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.25rem, 0.7vw, 0.35rem);
            color: #888;
            text-align: center;
            padding: 10px;
        }

        @media (max-width: 600px) {
            .game-container {
                border-width: 4px;
                max-height: 100vh;
            }

            .hud {
                padding: 8px 10px;
            }

            .target-area {
                top: 48px;
            }

            .game-area {
                top: 130px;
                height: calc(100% - 195px);
            }

            .spaceship {
                bottom: 18px;
            }

            .shoot-hint {
                bottom: 60px;
            }
        }
    </style>
</head>


<body>
    <!-- Challenge Music - from shared audio folder -->
    <audio id="challengeMusic" loop preload="auto">
        <source src="../audio/ES_Tiger Tracks - Lexica.mp3" type="audio/mpeg">
    </audio>
    
    <div class="crt-overlay"></div>
    <div class="starfield" id="starfield"></div>

    <div class="game-container" id="gameContainer">
        <!-- Login Screen -->
        <div class="screen" id="loginScreen">
            <h1 class="game-title">üêü BACALHAU √Ä BL√ÅST! üêü</h1>
            <p class="subtitle">ENTER YOUR NAME</p>
            <input type="text" class="username-input" id="usernameInput" placeholder="Your name..." maxlength="12">
            <button class="btn btn-gold" id="loginBtn">START</button>
            <div class="btn-row">
                <button class="btn btn-small btn-cyan" id="viewScoresBtn">üèÜ SCORES</button>
                <button class="btn btn-small btn-orange" id="importBtn">üì• IMPORT</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display:none">
        </div>

        <!-- Title Screen -->
        <div class="screen hidden" id="titleScreen">
            <h1 class="game-title">üêü BACALHAU √Ä BL√ÅST! üêü</h1>
            <p class="player-welcome">Welcome, <span id="playerName">Player</span>!</p>
            <div class="level-select-row">
                <label for="levelSelect" class="level-select-label">START AT:</label>
                <select id="levelSelect" class="level-select">
                    <option value="1">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4</option>
                    <option value="5">Level 5</option>
                </select>
            </div>
            <button class="btn btn-gold" id="startBtn">PLAY</button>
            <div class="btn-row">
                <button class="btn btn-small btn-cyan" id="statsBtn">üìä MY STATS</button>
                <button class="btn btn-small btn-red" id="scoresBtn">üèÜ SCOREBOARD</button>
            </div>
            <div class="btn-row">
                <button class="btn btn-small btn-orange" id="exportBtn">üì§ EXPORT</button>
                <button class="btn btn-small btn-cyan" id="changeUserBtn">üë§ CHANGE</button>
            </div>
            <div class="instructions">
                <span class="level-icon">üî§</span><span class="level-text">Level 1: Shoot the Sound (√£o, lh, nh, √ß)</span>
                <span class="level-icon">üìù</span><span class="level-text">Level 2: Shoot Words with Sounds</span>
                <span class="level-icon">‚ö†Ô∏è</span><span class="level-text">Level 3: False Friends (cognates)</span>
                <span class="level-icon">üéØ</span><span class="level-text">Level 4: Shoot the Meaning</span>
                <span class="level-icon">‚úçÔ∏è</span><span class="level-text">Level 5: Type the Portuguese</span>
            </div>
        </div>

        <!-- Stats Screen -->
        <div class="screen hidden" id="statsScreen">
            <h2 style="color: var(--neon-cyan); font-size: clamp(1rem, 3vw, 1.5rem);">üìä YOUR STATS</h2>
            <p class="player-welcome" id="statsPlayerName">Player</p>
            <div class="stats-container" id="statsContainer"></div>
            <button class="btn btn-cyan" id="statsBackBtn">BACK</button>
        </div>

        <!-- Scoreboard Screen -->
        <div class="screen hidden" id="scoreboardScreen">
            <h2 style="color: var(--neon-yellow); font-size: clamp(1rem, 3vw, 1.5rem);">üèÜ TOP SCORES</h2>
            <div class="scoreboard" id="scoreboardList"></div>
            <button class="btn btn-cyan" id="scoreboardBackBtn">BACK</button>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-item">SCORE: <span id="score">0</span></div>
            <div class="lives-display" id="livesDisplay"></div>
            <div class="hud-item cyan" id="modeDisplay">LEVEL 1</div>
            <div class="hud-item">RND: <span id="round">1</span></div>
            <button class="pause-btn" id="pauseBtn">‚ùö‚ùö</button>
        </div>

        <!-- Timer -->
        <div class="timer-sword hidden" id="timerSword">
            <span class="sword-icon">üêü</span>
            <div class="power-meter">
                <div class="power-label">POWER</div>
                <div class="power-bar" id="powerBar">
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                    <div class="power-segment"></div>
                </div>
            </div>
            <div class="power-time" id="powerTime">15s</div>
        </div>

        <!-- Penalty Indicator -->
        <div class="penalty-indicator" id="penaltyIndicator"></div>

        <!-- Audio Controls -->
        <div class="audio-controls">
            <button class="music-toggle" id="musicToggle" title="Toggle Music">üîä</button>
            <input type="range" class="volume-slider" id="bgVolumeSlider" min="0" max="100" value="50" title="Background Music Volume">
            <button class="playlist-btn" id="playlistBtn" title="Music Playlist">üéµ</button>
        </div>

        <!-- Playlist Menu -->
        <div class="playlist-menu hidden" id="playlistMenu">
            <div class="playlist-header">
                <h3>üéµ MUSIC PLAYLIST üéµ</h3>
                <button class="playlist-close" id="playlistClose">‚úï</button>
            </div>
            <div class="playlist-content">
                <div class="playlist-section">
                    <h4>Built-in 8-bit Music</h4>
                    <button class="playlist-track active" data-track="8bit">üéÆ Retro Chiptune (Default)</button>
                </div>
                <div class="playlist-section">
                    <h4>External Tracks</h4>
                    <div class="playlist-tracks" id="playlistTracks">
                        <p class="playlist-info">Place MP3 files in portuguese/ folder</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Target Area -->
        <div class="target-area">
            <div class="target-label" id="targetLabel">üéØ SHOOT THIS LETTER üéØ</div>
            <div class="target-letter" id="targetLetter">A</div>
            <button class="speak-btn" id="speakBtn">üîä HEAR IT</button>
        </div>

        <!-- Game Area -->
        <div class="game-area" id="gameArea"></div>
        <div class="shoot-hint" id="shootHint">TAP TO SHOOT! üî´</div>
        <div class="spaceship" id="spaceship">
            <svg viewBox="0 0 70 85" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Bacalhau (Codfish) - Large, golden-brown, distinctive -->
                <!-- Main body - elongated, larger -->
                <ellipse cx="35" cy="42" rx="30" ry="20" fill="#C4A35A"/>
                <ellipse cx="35" cy="42" rx="27" ry="17" fill="#D4B56A"/>
                <!-- Distinctive cod pattern spots -->
                <circle cx="22" cy="38" r="4" fill="#8B7355" opacity="0.5"/>
                <circle cx="35" cy="35" r="3" fill="#8B7355" opacity="0.5"/>
                <circle cx="48" cy="40" r="4" fill="#8B7355" opacity="0.5"/>
                <circle cx="28" cy="48" r="3" fill="#8B7355" opacity="0.5"/>
                <circle cx="42" cy="46" r="3" fill="#8B7355" opacity="0.5"/>
                <!-- Dorsal fin - larger -->
                <path d="M18 25 Q28 12 35 15 Q42 12 52 25 L47 32 Q35 28 23 32 Z" fill="#A08040"/>
                <!-- Tail fin - large, forked -->
                <path d="M62 32 Q75 25 78 38 L68 42 L78 48 Q75 60 62 52 Q60 42 62 32" fill="#A08040"/>
                <!-- Pectoral fin -->
                <path d="M18 42 Q5 35 3 48 Q12 55 20 48" fill="#B89050"/>
                <!-- Ventral fin -->
                <path d="M30 58 Q35 68 40 58" fill="#A08040"/>
                <!-- Head - larger, distinctive -->
                <ellipse cx="10" cy="42" rx="12" ry="14" fill="#D4B56A"/>
                <!-- Eye - large -->
                <circle cx="6" cy="38" r="6" fill="white"/>
                <circle cx="5" cy="37" r="4" fill="#1a1a2a"/>
                <circle cx="4" cy="36" r="1.5" fill="white"/>
                <!-- Mouth -->
                <path d="M-2 46 Q3 52 10 48" stroke="#8B7355" stroke-width="2" fill="none"/>
                <!-- Gill lines -->
                <path d="M18 36 Q21 42 18 48" stroke="#8B7355" stroke-width="1.5" fill="none"/>
                <!-- Barbel (chin whisker - distinctive cod feature) -->
                <path d="M2 50 Q-2 60 3 65" stroke="#A08040" stroke-width="3" fill="none" stroke-linecap="round"/>
                <!-- Belly - lighter -->
                <ellipse cx="35" cy="52" rx="22" ry="10" fill="#E8D88A" opacity="0.6"/>
                <!-- Portuguese flag accent on body -->
                <rect x="32" y="38" width="12" height="3" fill="#006600" rx="1"/>
                <rect x="32" y="42" width="12" height="3" fill="#ff0000" rx="1"/>
            </svg>
        </div>

        <!-- Dictation Area (Level 5) -->
        <div class="dictation-area hidden" id="dictationArea">
            <div class="dictation-prompt" id="dictationPrompt">hello</div>
            <button class="speak-btn" id="dictationSpeakBtn">üîä HEAR IT</button>
            <input type="text" class="dictation-input" id="dictationInput"
                placeholder="Type Portuguese translation...">
            <p class="dictation-hint">Listen to the Portuguese word and type it</p>
            <div class="btn-row">
                <button class="btn btn-gold btn-small" id="dictationSubmitBtn">SUBMIT</button>
                <button class="btn btn-orange btn-small" id="beatsMeBtn">BEATS ME!</button>
            </div>
        </div>

        <!-- Challenge Modal (Treasure Chest) -->
        <div class="challenge-modal hidden" id="challengeModal">
            <div class="challenge-audio-controls">
                <button class="challenge-music-toggle" id="challengeMusicToggle" title="Toggle Challenge Music">üîä</button>
                <input type="range" class="volume-slider challenge-volume" id="challengeVolumeSlider" min="0" max="100" value="50" title="Challenge Music Volume">
            </div>
            <h2 class="challenge-title">
                üè¥‚Äç‚ò†Ô∏è TREASURE CHALLENGE! üè¥‚Äç‚ò†Ô∏è
            </h2>
            <p class="challenge-question" id="challengeQuestion">Question goes here</p>
            <div class="challenge-options" id="challengeOptions">
                <!-- Options will be inserted here -->
            </div>
            <p class="challenge-result hidden" id="challengeResult"></p>
            <div class="double-down-section hidden" id="doubleDownSection">
                <p class="double-down-text">Wrong! Choose your fate:</p>
                <div class="challenge-buttons">
                    <button class="btn btn-cyan btn-small" id="returnBtn">RETURN (safe)</button>
                    <button class="btn btn-orange btn-small" id="doubleDownBtn">GOIN' FOR IT! üî•</button>
                </div>
            </div>
            <button class="btn btn-cyan btn-small hidden" id="challengeContinueBtn">CONTINUE</button>
        </div>

        <!-- Pause Overlay -->
        <div class="pause-overlay hidden" id="pauseOverlay">
            <h2 class="pause-title">‚è∏Ô∏è PAUSED</h2>
            <button class="btn btn-gold" id="resumeBtn">‚ñ∂ RESUME</button>
            <button class="btn btn-orange" id="quitBtn">‚úñ QUIT</button>
        </div>

        <!-- Level Complete Screen -->
        <div class="screen hidden" id="levelComplete">
            <h2 style="color: var(--neon-yellow); font-size: clamp(1.5rem, 4vw, 2.5rem);" id="levelCompleteTitle">üéâ
                AWESOME! üéâ</h2>
            <p style="color: var(--neon-cyan); font-size: 0.7rem;" id="levelCompleteText">Level Complete!</p>
            <div class="level-intro" id="nextLevelIntro"></div>
            <div class="stars-earned" id="starsEarned"></div>
            <button class="btn btn-cyan" id="continueBtn">CONTINUE</button>
        </div>

        <!-- Game Complete Screen -->
        <div class="screen hidden" id="gameComplete">
            <h2 style="color: var(--neon-yellow); font-size: clamp(1.5rem, 4vw, 2.5rem);">üèÜ YOU WIN! üèÜ</h2>
            <p style="color: var(--neon-cyan); font-size: 0.7rem;">All Levels Complete!</p>
            <p class="final-score">SCORE: <span id="winScore">0</span></p>
            <div class="stars-earned" id="winStars"></div>
            <button class="btn btn-gold" id="playAgainBtn">PLAY AGAIN</button>
            <button class="btn btn-small btn-cyan" id="winMenuBtn">MENU</button>
        </div>

        <!-- Game Over Screen -->
        <div class="screen hidden" id="gameOver">
            <h2 style="color: var(--neon-pink); font-size: clamp(1.5rem, 4vw, 2.5rem);">GAME OVER</h2>
            <p class="final-score">SCORE: <span id="finalScore">0</span></p>
            <p style="color: var(--neon-cyan); font-size: 0.5rem; margin-top: 10px;">Great effort!</p>
            <button class="btn btn-gold" id="retryBtn">TRY AGAIN</button>
            <button class="btn btn-small btn-cyan" id="gameOverMenuBtn">MENU</button>
        </div>
    </div>

    <script>
        // Portuguese Phonics Data
        // Portuguese Phonics Data
        const PT_SOUNDS = [
            { char: '√£o', ipa: '/…êÃÉwÃÉ/', meaning: 'nasal "ow"', example: 'cora√ß√£o' },
            { char: '√µes', ipa: '/√µj É/', meaning: 'plural nasal', example: 'na√ß√µes' },
            { char: '√£e', ipa: '/…êÃÉj/', meaning: 'nasal "ay"', example: 'm√£e' },
            { char: 'lh', ipa: '/ é/', meaning: 'like "lli" in million', example: 'milh√£o' },
            { char: 'nh', ipa: '/…≤/', meaning: 'like "√±" in espa√±ol', example: 'vinho' },
            { char: '√ß', ipa: '/s/', meaning: 'soft "s" sound', example: 'ma√ß√£' },
            { char: 'ch', ipa: '/ É/', meaning: '"sh" sound', example: 'chuva' },
            { char: 'rr', ipa: '/ Ä/', meaning: 'guttural "r"', example: 'carro' },
            { char: 'ss', ipa: '/s/', meaning: 'sharp "s"', example: 'p√°ssaro' },
            { char: 'ou', ipa: '/o/', meaning: '"oh" sound', example: 'ouro' },
            { char: 'ei', ipa: '/…êj/', meaning: '"ay" sound', example: 'leite' },
            { char: 'oi', ipa: '/oj/', meaning: '"oy" sound', example: 'noite' }
        ];

        // Words containing the sounds (Level 2)
        const PT_WORDS = [
            { word: 'cora√ß√£o', pinyin: 'koh-rah-SOW~', meaning: 'heart', sound: '√£o' },
            { word: 'milh√£o', pinyin: 'mee-LYOW~', meaning: 'million', sound: 'lh' },
            { word: 'amanh√£', pinyin: 'ah-mah-NYAH~', meaning: 'tomorrow', sound: 'nh' },
            { word: 'ma√ß√£', pinyin: 'mah-SAH~', meaning: 'apple', sound: '√ß' },
            { word: 'chuva', pinyin: 'SHOO-vah', meaning: 'rain', sound: 'ch' },
            { word: 'carro', pinyin: 'KAH-hoo', meaning: 'car', sound: 'rr' },
            { word: 'p√°ssaro', pinyin: 'PAH-sah-roo', meaning: 'bird', sound: 'ss' },
            { word: 'bacalhau', pinyin: 'bah-kah-LYOW', meaning: 'codfish', sound: 'lh' },
            { word: 'trabalho', pinyin: 'trah-BAH-lyoo', meaning: 'work', sound: 'lh' },
            { word: 'vinho', pinyin: 'VEE-nyoo', meaning: 'wine', sound: 'nh' },
            { word: 'na√ß√µes', pinyin: 'nah-SOYSH~', meaning: 'nations', sound: '√µes' },
            { word: 'sauda√ß√µes', pinyin: 'sow-dah-SOYSH~', meaning: 'greetings', sound: '√µes' }
        ];

        // False Friends (Level 3)
        const FALSE_FRIENDS = [
            // False Friends (tricky ones - the main gameplay!)
            { word: 'constipado', meaning: 'has a cold', false: 'constipated', correct: 'cold' },
            { word: 'preservativo', meaning: 'condom', false: 'preservative', correct: 'condom' },
            { word: 'exquisito', meaning: 'strange/weird', false: 'exquisite', correct: 'strange' },
            { word: 'livraria', meaning: 'bookshop', false: 'library', correct: 'bookshop' },
            { word: 'puxar', meaning: 'to pull', false: 'to push', correct: 'pull' },
            { word: 'assistir', meaning: 'to watch/attend', false: 'to assist', correct: 'watch' },
            { word: 'col√©gio', meaning: 'high school', false: 'college', correct: 'high school' },
            { word: 'pretender', meaning: 'to intend/plan', false: 'to pretend', correct: 'intend' },
            { word: 'sens√≠vel', meaning: 'sensitive', false: 'sensible', correct: 'sensitive' },
            { word: 'atualmente', meaning: 'currently/nowadays', false: 'actually', correct: 'currently' },
            { word: 'eventual', meaning: 'possible/occasional', false: 'eventual', correct: 'possible' },
            { word: 'not√≠cia', meaning: 'news', false: 'notice', correct: 'news' },
            { word: 'parente', meaning: 'relative', false: 'parent', correct: 'relative' },
            { word: 'pasta', meaning: 'folder/briefcase', false: 'pasta', correct: 'folder' },
            { word: 'propaganda', meaning: 'advertisement', false: 'propaganda', correct: 'advertisement' },
            { word: 'realizar', meaning: 'to accomplish/achieve', false: 'to realize', correct: 'accomplish' },
            { word: 'recordar', meaning: 'to remember', false: 'to record', correct: 'remember' },
            { word: 'resumo', meaning: 'summary', false: 'resume', correct: 'summary' },
            { word: 'costume', meaning: 'habit/custom', false: 'costume', correct: 'habit' },
            { word: 'data', meaning: 'date (calendar)', false: 'data', correct: 'date' },
            { word: 'intoxicado', meaning: 'food poisoned', false: 'intoxicated', correct: 'poisoned' },
            { word: 'largo', meaning: 'wide/square (plaza)', false: 'large', correct: 'wide' },
            { word: 'legenda', meaning: 'subtitle/caption', false: 'legend', correct: 'subtitle' },
            { word: 'particular', meaning: 'private', false: 'particular', correct: 'private' },
            { word: 'taxa', meaning: 'fee/rate', false: 'tax', correct: 'fee' },
            { word: 'compromisso', meaning: 'commitment/appointment', false: 'compromise', correct: 'commitment' },
            { word: 'decep√ß√£o', meaning: 'disappointment', false: 'deception', correct: 'disappointment' },
            { word: 'educado', meaning: 'polite/well-mannered', false: 'educated', correct: 'polite' },
            { word: 'f√°brica', meaning: 'factory', false: 'fabric', correct: 'factory' },
            { word: 'acordar', meaning: 'to wake up', false: 'to accord', correct: 'wake up' },
            // True Friends (cognates that DO match - easier ones)
            { word: 'telefone', meaning: 'telephone', false: 'telephone', correct: 'telephone' },
            { word: 'm√∫sica', meaning: 'music', false: 'music', correct: 'music' },
            { word: 'hospital', meaning: 'hospital', false: 'hospital', correct: 'hospital' },
            { word: 'problema', meaning: 'problem', false: 'problem', correct: 'problem' },
            { word: 'importante', meaning: 'important', false: 'important', correct: 'important' },
            { word: 'diferente', meaning: 'different', false: 'different', correct: 'different' },
            { word: 'animal', meaning: 'animal', false: 'animal', correct: 'animal' },
            { word: 'natural', meaning: 'natural', false: 'natural', correct: 'natural' },
            { word: 'central', meaning: 'central', false: 'central', correct: 'central' },
            { word: 'total', meaning: 'total', false: 'total', correct: 'total' }
        ];

        // Vocabulary (Level 4) - Tiered by difficulty
        const PT_VOCAB_A1 = [
            // Basic greetings and essentials
            { word: 'ol√°', meaning: 'hello' },
            { word: 'adeus', meaning: 'goodbye' },
            { word: 'sim', meaning: 'yes' },
            { word: 'n√£o', meaning: 'no' },
            { word: 'obrigado', meaning: 'thank you (m)' },
            { word: 'obrigada', meaning: 'thank you (f)' },
            { word: 'por favor', meaning: 'please' },
            { word: 'desculpe', meaning: 'sorry' },
            { word: 'bom dia', meaning: 'good morning' },
            { word: 'boa tarde', meaning: 'good afternoon' },
            { word: 'boa noite', meaning: 'good night' },
            { word: '√°gua', meaning: 'water' },
            { word: 'comida', meaning: 'food' },
            { word: 'casa', meaning: 'house' },
            { word: 'amor', meaning: 'love' }
        ];

        const PT_VOCAB_A2 = [
            // Travel and daily life
            { word: 'quanto custa', meaning: 'how much' },
            { word: 'onde fica', meaning: 'where is' },
            { word: 'preciso de', meaning: 'I need' },
            { word: 'estou perdido', meaning: 'I am lost' },
            { word: 'ajuda', meaning: 'help' },
            { word: 'hospital', meaning: 'hospital' },
            { word: 'farm√°cia', meaning: 'pharmacy' },
            { word: 'restaurante', meaning: 'restaurant' },
            { word: 'aeroporto', meaning: 'airport' },
            { word: 'praia', meaning: 'beach' },
            { word: 'cidade', meaning: 'city' },
            { word: 'trabalho', meaning: 'work' },
            { word: 'fam√≠lia', meaning: 'family' },
            { word: 'amigo', meaning: 'friend' },
            { word: 'tempo', meaning: 'time/weather' }
        ];

        const PT_VOCAB_B1B2 = [
            // Advanced/Cultural terms
            { word: 'saudade', meaning: 'longing/nostalgia' },
            { word: 'madrugada', meaning: 'early morning' },
            { word: 'apaixonado', meaning: 'in love' },
            { word: 'conseguir', meaning: 'to achieve' },
            { word: 'desenrascar', meaning: 'to improvise' },
            { word: 'chatear', meaning: 'to annoy' },
            { word: 'giro', meaning: 'cool/cute' },
            { word: 'fixe', meaning: 'cool/great' },
            { word: 'pormenor', meaning: 'detail' },
            { word: 'entretanto', meaning: 'meanwhile' },
            { word: 'sobremesa', meaning: 'dessert' },
            { word: 'mariscos', meaning: 'seafood' },
            { word: 'azulejo', meaning: 'tile' },
            { word: 'miradouro', meaning: 'viewpoint' },
            { word: 'tasca', meaning: 'tavern' }
        ];

        // Combined for backward compatibility
        const PT_VOCAB = [...PT_VOCAB_A1, ...PT_VOCAB_A2, ...PT_VOCAB_B1B2];

        // Dictation words (Level 5) - English prompt, Portuguese answer
        const DICTATION_WORDS = [
            { word: 'hello', pinyin: 'ol√°' },
            { word: 'goodbye', pinyin: 'adeus' },
            { word: 'thank you', pinyin: 'obrigado' },
            { word: 'please', pinyin: 'por favor' },
            { word: 'yes', pinyin: 'sim' },
            { word: 'no', pinyin: 'n√£o' },
            { word: 'good', pinyin: 'bom' },
            { word: 'bad', pinyin: 'mau' },
            { word: 'water', pinyin: '√°gua' },
            { word: 'food', pinyin: 'comida' },
            { word: 'house', pinyin: 'casa' },
            { word: 'love', pinyin: 'amor' }
        ];

        // Challenge Questions (Portuguese culture, history, food)
        const CHALLENGE_QUESTIONS = [
            // ============================================
            // CATEGORY 1: PORTUGUESE LANGUAGE CURIOSITIES (50)
            // ============================================
            
            // Untranslatable words & unique concepts
            { q: "What Portuguese word describes 'the art of improvising solutions with limited resources'?", options: ["Saudade", "Desenrascan√ßo", "Aconchego", "Madrugada"], a: "Desenrascan√ßo" },
            { q: "What does 'saudade' most accurately describe?", options: ["Happiness", "A melancholic longing for something absent", "Anger", "Fear"], a: "A melancholic longing for something absent" },
            { q: "What does 'madrugada' refer to in Portuguese?", options: ["Midnight exactly", "The early morning hours before dawn", "Sunset", "Noon"], a: "The early morning hours before dawn" },
            { q: "What does 'lusco-fusco' poetically describe?", options: ["A loud noise", "The twilight hour between day and night", "A type of fish", "A dance"], a: "The twilight hour between day and night" },
            { q: "'Aconchego' describes a feeling of:", options: ["Sadness", "Cozy warmth and comfort", "Anger", "Confusion"], a: "Cozy warmth and comfort" },
            
            // Portuguese linguistic uniqueness
            { q: "What grammatical feature is unique to Portuguese among Romance languages?", options: ["Gendered nouns", "The personal infinitive", "Verb conjugations", "Articles"], a: "The personal infinitive" },
            { q: "The mesoclisis (putting pronouns inside verbs) is used in:", options: ["Casual speech", "Formal/literary Portuguese", "Only in Brazil", "Never anymore"], a: "Formal/literary Portuguese" },
            { q: "What is 'tu' vs 'voc√™' usage like in Portugal?", options: ["Tu is never used", "Tu is informal, voc√™ varies by region", "They're identical", "Voc√™ is never used"], a: "Tu is informal, voc√™ varies by region" },
            { q: "In European Portuguese, the word 'autocarro' means:", options: ["Car", "Bus", "Train", "Taxi"], a: "Bus" },
            { q: "What does 'telem√≥vel' mean in European Portuguese?", options: ["Television", "Mobile phone", "Remote control", "Telephone"], a: "Mobile phone" },
            
            // Grammar & language quirks
            { q: "What term did Fernando Pessoa invent for his literary alter-egos?", options: ["Pseudonyms", "Heteronyms", "Synonyms", "Antonyms"], a: "Heteronyms" },
            { q: "Portuguese is the official language of how many countries?", options: ["5", "7", "9", "11"], a: "9" },
            { q: "What is the global community of Portuguese-speaking nations called?", options: ["Lusofonia", "Portugalidade", "Comunidade", "Iberia"], a: "Lusofonia" },
            { q: "European Portuguese is known for 'eating' which sounds?", options: ["Consonants", "Unstressed vowels", "Final syllables", "Nothing"], a: "Unstressed vowels" },
            { q: "The '√£o' nasal sound in Portuguese is often compared to:", options: ["French nasal vowels", "Spanish '√±'", "Italian double consonants", "German umlauts"], a: "French nasal vowels" },
            { q: "What is the Portuguese personal infinitive?", options: ["An infinitive verb with personal endings", "A type of noun", "A past tense", "A subjunctive mood"], a: "An infinitive verb with personal endings" },
            { q: "In Portuguese, 'voc√™' is:", options: ["Always formal", "Always informal", "Varies by region and context", "Never used"], a: "Varies by region and context" },
            { q: "The word 'saudade' likely comes from the Latin word for:", options: ["Sadness", "Solitude", "Soul", "Sound"], a: "Solitude" },
            { q: "What percentage of Portuguese vocabulary comes from Latin?", options: ["About 50%", "About 70%", "About 90%", "About 30%"], a: "About 90%" },
            { q: "Which language influenced Portuguese with words like 'alf√¢ndega' and 'azulejo'?", options: ["French", "Arabic", "Greek", "German"], a: "Arabic" },
            
            // Etymology & word origins
            { q: "'Azulejo' (Portuguese tile) comes from Arabic meaning:", options: ["Blue tile", "Small polished stone", "Wall art", "Ceramic"], a: "Small polished stone" },
            { q: "The word 'fado' comes from Latin 'fatum' meaning:", options: ["Song", "Fate/destiny", "Sadness", "Guitar"], a: "Fate/destiny" },
            { q: "Portuguese word 'ch√°' (tea) came from:", options: ["Chinese", "English", "Indian", "Japanese"], a: "Chinese" },
            { q: "'Fetiche' was a Portuguese word later borrowed into English as:", options: ["Festival", "Fetish", "Feature", "Finish"], a: "Fetish" },
            { q: "The English word 'marmalade' comes from Portuguese:", options: ["Marmelada (quince jam)", "Maravilha", "Maracuj√°", "Morango"], a: "Marmelada (quince jam)" },
            { q: "Which Portuguese word became English 'cobra'?", options: ["Cobra de capelo", "Serpente", "Lagarto", "V√≠bora"], a: "Cobra de capelo" },
            { q: "'Embarcar' (to embark) gave English which word?", options: ["Embargo", "Embarrass", "Embrace", "Embark"], a: "Embargo" },
            { q: "The word 'baroque' likely comes from Portuguese 'barroco' meaning:", options: ["Ornate style", "Irregular pearl", "Church art", "Royal palace"], a: "Irregular pearl" },
            
            // Expressions & idioms
            { q: "'Tirar o cavalinho da chuva' means:", options: ["Take your horse from the rain", "Give up on something", "Start something new", "Work harder"], a: "Give up on something" },
            { q: "'Pagar o pato' (pay the duck) means:", options: ["Buy poultry", "Take the blame for others", "Win a prize", "Celebrate"], a: "Take the blame for others" },
            { q: "What does 'Estou com a pulga atr√°s da orelha' express?", options: ["I have an itch", "I'm suspicious about something", "I'm happy", "I'm tired"], a: "I'm suspicious about something" },
            { q: "'Ficar com a cara no ch√£o' means:", options: ["Fall asleep", "Be deeply embarrassed", "Be angry", "Be confused"], a: "Be deeply embarrassed" },
            { q: "'Meter √°gua' literally means 'to put water in' but actually means:", options: ["To water plants", "To fail or make mistakes", "To clean", "To cook"], a: "To fail or make mistakes" },
            { q: "'Engolir sapos' (swallow frogs) means:", options: ["Eat exotic food", "Accept humiliation silently", "Be brave", "Talk nonsense"], a: "Accept humiliation silently" },
            { q: "What is 'falar pelos cotovelos'?", options: ["Whisper", "Talk excessively", "Speak quietly", "Sing"], a: "Talk excessively" },
            { q: "'Dar com os burros n'√°gua' means:", options: ["Find water for donkeys", "Fail completely", "Succeed against odds", "Travel far"], a: "Fail completely" },
            
            // Pronunciation & phonetics
            { q: "The Portuguese 'nh' sound is similar to:", options: ["Spanish '√±'", "French 'gn'", "Both Spanish '√±' and French 'gn'", "Neither"], a: "Both Spanish '√±' and French 'gn'" },
            { q: "In European Portuguese, unstressed 'e' often sounds like:", options: ["A clear 'e'", "Almost silent or 'uh'", "Like 'i'", "Like 'a'"], a: "Almost silent or 'uh'" },
            { q: "The Portuguese 'lh' makes a sound similar to:", options: ["English 'l'", "Spanish 'll' or Italian 'gl'", "French 'l'", "German 'l'"], a: "Spanish 'll' or Italian 'gl'" },
            { q: "In European Portuguese, final 's' before a pause sounds like:", options: ["English 's'", "English 'sh'", "Silent", "Buzzing 'z'"], a: "English 'sh'" },
            { q: "The European Portuguese 'r' in Lisbon is pronounced:", options: ["Rolled like Spanish", "Guttural like French", "Silent", "Like English 'r'"], a: "Guttural like French" },
            
            // ============================================
            // CATEGORY 2: PORTUGUESE HISTORY (50)
            // ============================================
            
            // Carnation Revolution
            { q: "What was the secret code name for the 1974 revolution?", options: ["Operation Freedom", "Operation Historic Turn", "Operation Democracy", "Operation April"], a: "Operation Historic Turn" },
            { q: "Which song was the radio signal to start the Carnation Revolution?", options: ["Fado Portugu√™s", "Gr√¢ndola, Vila Morena", "A Portuguesa", "April in Portugal"], a: "Gr√¢ndola, Vila Morena" },
            { q: "Who wrote 'Gr√¢ndola, Vila Morena'?", options: ["Am√°lia Rodrigues", "Jos√© Afonso (Zeca Afonso)", "Carlos Paredes", "Dulce Pontes"], a: "Jos√© Afonso (Zeca Afonso)" },
            { q: "The first signal on the radio played which Eurovision entry?", options: ["A Festa da Vida", "E Depois do Adeus", "Playback", "Bem Bom"], a: "E Depois do Adeus" },
            { q: "Who was the captain who led troops to surround the Carmo Barracks?", options: ["Otelo Saraiva de Carvalho", "Salgueiro Maia", "Vasco Louren√ßo", "V√≠tor Alves"], a: "Salgueiro Maia" },
            { q: "Who was President of Portugal when the Carnation Revolution happened?", options: ["Ant√≥nio de Sp√≠nola", "Am√©rico Tom√°s", "Marcelo Caetano", "M√°rio Soares"], a: "Am√©rico Tom√°s" },
            { q: "Who was Prime Minister during the Carnation Revolution?", options: ["Salazar", "Marcelo Caetano", "M√°rio Soares", "Sp√≠nola"], a: "Marcelo Caetano" },
            { q: "Where did Marcelo Caetano surrender on April 25, 1974?", options: ["S√£o Bento Palace", "Carmo Barracks", "Bel√©m Palace", "Ajuda Palace"], a: "Carmo Barracks" },
            { q: "How many people died from revolutionary forces during the Carnation Revolution?", options: ["Hundreds", "Dozens", "Four civilians (by secret police)", "None"], a: "Four civilians (by secret police)" },
            { q: "Who gave carnations to soldiers, inspiring the revolution's name?", options: ["Am√°lia Rodrigues", "Celeste Caeiro", "Maria de Medeiros", "Sophia de Mello"], a: "Celeste Caeiro" },
            { q: "Who coordinated the revolution from the Pontinha command post?", options: ["Salgueiro Maia", "Otelo Saraiva de Carvalho", "Sp√≠nola", "Ramalho Eanes"], a: "Otelo Saraiva de Carvalho" },
            { q: "What was the MFA (Movimento das For√ßas Armadas)?", options: ["A political party", "The Armed Forces Movement that overthrew the regime", "A trade union", "A newspaper"], a: "The Armed Forces Movement that overthrew the regime" },
            { q: "What famous quote did Salgueiro Maia say about the revolution?", options: ["Today we make history", "The revolution doesn't stop for red lights", "Freedom at last", "Victory is ours"], a: "The revolution doesn't stop for red lights" },
            
            // Estado Novo & Salazar
            { q: "For how many years did the Estado Novo dictatorship last?", options: ["28 years", "36 years", "41 years", "48 years"], a: "41 years" },
            { q: "What was Salazar's profession before entering politics?", options: ["Military general", "Lawyer", "University professor of economics", "Businessman"], a: "University professor of economics" },
            { q: "At which university did Salazar teach before becoming dictator?", options: ["University of Lisbon", "University of Porto", "University of Coimbra", "University of √âvora"], a: "University of Coimbra" },
            { q: "What was PIDE?", options: ["A political party", "The secret police", "A news agency", "A labor union"], a: "The secret police" },
            { q: "What happened to Salazar in 1968?", options: ["He was assassinated", "He fell from a chair and suffered a stroke", "He fled to Brazil", "He was voted out"], a: "He fell from a chair and suffered a stroke" },
            { q: "After Salazar's stroke, who replaced him as leader?", options: ["Am√©rico Tom√°s", "Marcelo Caetano", "Ant√≥nio de Sp√≠nola", "M√°rio Soares"], a: "Marcelo Caetano" },
            { q: "Did Salazar know he had been replaced as Prime Minister?", options: ["Yes, immediately", "No, he was never told", "Yes, after 6 months", "He demanded to be reinstated"], a: "No, he was never told" },
            { q: "What was Tarrafal?", options: ["A beach resort", "A concentration camp in Cape Verde", "A military base", "A palace"], a: "A concentration camp in Cape Verde" },
            { q: "What did Portugal claim about its African territories?", options: ["They were independent nations", "They were overseas provinces of Portugal", "They were temporary colonies", "They were UN mandates"], a: "They were overseas provinces of Portugal" },
            { q: "Who was Humberto Delgado?", options: ["A fado singer", "An opposition leader assassinated by PIDE", "Salazar's successor", "A military general loyal to Salazar"], a: "An opposition leader assassinated by PIDE" },
            { q: "Portugal was neutral during WWII but secretly traded what with Nazi Germany?", options: ["Oil", "Wolfram (tungsten)", "Iron", "Gold"], a: "Wolfram (tungsten)" },
            { q: "In 2007, who won the controversial 'Greatest Portuguese' TV poll?", options: ["Vasco da Gama", "Fernando Pessoa", "Ant√≥nio de Oliveira Salazar", "Lu√≠s de Cam√µes"], a: "Ant√≥nio de Oliveira Salazar" },
            
            // Age of Discovery
            { q: "What year did Vasco da Gama reach India by sea?", options: ["1488", "1492", "1498", "1500"], a: "1498" },
            { q: "The Treaty of Tordesillas (1494) divided the world between:", options: ["Portugal and England", "Portugal and Spain", "Portugal and France", "Spain and England"], a: "Portugal and Spain" },
            { q: "How many leagues west of Cape Verde was the Tordesillas line?", options: ["100 leagues", "270 leagues", "370 leagues", "500 leagues"], a: "370 leagues" },
            { q: "Which Portuguese explorer first rounded the Cape of Good Hope?", options: ["Vasco da Gama", "Bartolomeu Dias", "Pedro √Ålvares Cabral", "Ferdinand Magellan"], a: "Bartolomeu Dias" },
            { q: "Who officially 'discovered' Brazil for Portugal in 1500?", options: ["Vasco da Gama", "Pedro √Ålvares Cabral", "Ferdinand Magellan", "Afonso de Albuquerque"], a: "Pedro √Ålvares Cabral" },
            { q: "Which prince earned the title 'Navigator' for promoting exploration?", options: ["Prince Pedro", "Prince Henry", "Prince Ferdinand", "Prince Afonso"], a: "Prince Henry" },
            { q: "Ferdinand Magellan, though Portuguese, sailed under which flag?", options: ["Portuguese", "Spanish", "English", "Dutch"], a: "Spanish" },
            { q: "What was Portugal's main goal in the Age of Discovery?", options: ["Spreading democracy", "Finding spices and trade routes to Asia", "Escaping famine", "Finding gold in Americas"], a: "Finding spices and trade routes to Asia" },
            { q: "Which city did Portugal conquer to control the spice trade in 1510?", options: ["Calcutta", "Goa", "Mumbai", "Chennai"], a: "Goa" },
            { q: "What Portuguese innovation made long ocean voyages possible?", options: ["The caravel ship", "The steam engine", "The compass (invented in Portugal)", "The submarine"], a: "The caravel ship" },
            { q: "Macau was a Portuguese territory until which year?", options: ["1975", "1987", "1997", "1999"], a: "1999" },
            { q: "How long was the Portuguese Colonial War in Africa?", options: ["5 years", "8 years", "13 years", "20 years"], a: "13 years" },
            
            // Other History
            { q: "When did Portugal become a republic?", options: ["1822", "1890", "1910", "1926"], a: "1910" },
            { q: "What was the Reconquista?", options: ["Portuguese independence from Spain", "Christian reconquest of Iberia from Moors", "Colonial expansion", "Industrial revolution"], a: "Christian reconquest of Iberia from Moors" },
            { q: "When did Portugal gain independence from the Kingdom of Le√≥n?", options: ["1139", "1249", "1385", "1415"], a: "1139" },
            { q: "Who was Portugal's first king?", options: ["Afonso Henriques", "Sancho I", "Dinis I", "Jo√£o I"], a: "Afonso Henriques" },
            { q: "The 1755 Lisbon earthquake occurred on which religious holiday?", options: ["Easter", "Christmas", "All Saints' Day", "Good Friday"], a: "All Saints' Day" },
            { q: "Who rebuilt Lisbon after the 1755 earthquake?", options: ["King Jos√© I", "Marqu√™s de Pombal", "Prince Henry", "Queen Maria I"], a: "Marqu√™s de Pombal" },
            { q: "When did Portugal join the European Union (then EEC)?", options: ["1974", "1981", "1986", "1992"], a: "1986" },
            { q: "The Battle of Aljubarrota (1385) secured independence from:", options: ["Spain", "Castile", "Morocco", "France"], a: "Castile" },
            
            // ============================================
            // CATEGORY 3: PORTUGUESE CULTURE TRIVIA (50)
            // ============================================
            
            // Food & Drink
            { q: "According to Portuguese tradition, how many ways can bacalhau be cooked?", options: ["100", "200", "365", "500"], a: "365" },
            { q: "What is the main ingredient in 'Caldo Verde'?", options: ["Potatoes and kale", "Tomatoes and onions", "Fish and rice", "Beans and sausage"], a: "Potatoes and kale" },
            { q: "Pastel de nata originated from which Lisbon neighborhood?", options: ["Alfama", "Bel√©m", "Bairro Alto", "Chiado"], a: "Bel√©m" },
            { q: "What type of wine is Port wine?", options: ["Dry white", "Fortified sweet wine", "Sparkling", "Ros√©"], a: "Fortified sweet wine" },
            { q: "What is 'francesinha'?", options: ["A French woman", "A sandwich covered in melted cheese and sauce from Porto", "A type of bread", "A dessert"], a: "A sandwich covered in melted cheese and sauce from Porto" },
            { q: "Ginjinha is a Portuguese liqueur made from:", options: ["Grapes", "Sour cherries", "Oranges", "Almonds"], a: "Sour cherries" },
            { q: "What is 'tripas √† moda do Porto'?", options: ["Grilled fish", "Tripe stew", "Roasted chicken", "Seafood rice"], a: "Tripe stew" },
            { q: "Why are people from Porto called 'tripeiros'?", options: ["They love tripe", "They gave their meat to sailors and ate only tripe", "They invented tripe dishes", "It's an insult"], a: "They gave their meat to sailors and ate only tripe" },
            { q: "What is the traditional Christmas dessert 'Bolo Rei'?", options: ["Chocolate cake", "Fruit-filled crown cake with a hidden fava bean", "Cheesecake", "Custard tart"], a: "Fruit-filled crown cake with a hidden fava bean" },
            { q: "Vinho Verde is:", options: ["Green-colored wine", "Wine from green grapes only", "Young, slightly sparkling wine", "Wine with herbs"], a: "Young, slightly sparkling wine" },
            { q: "'Arroz de pato' is rice with:", options: ["Chicken", "Duck", "Fish", "Shrimp"], a: "Duck" },
            
            // Fado & Music
            { q: "In which Lisbon neighborhood did fado originate?", options: ["Bel√©m", "Alfama", "Bairro Alto", "Chiado"], a: "Alfama" },
            { q: "What is the traditional Portuguese guitar used in fado?", options: ["Classical guitar", "Portuguese guitarra (12-string pear-shaped)", "Acoustic guitar", "Mandolin"], a: "Portuguese guitarra (12-string pear-shaped)" },
            { q: "What year was fado inscribed as UNESCO Intangible Cultural Heritage?", options: ["2005", "2008", "2011", "2015"], a: "2011" },
            { q: "Which award did Am√°lia Rodrigues receive posthumously?", options: ["Nobel Prize", "Burial in the National Pantheon", "Grammy Lifetime Achievement", "Eurovision winner"], a: "Burial in the National Pantheon" },
            { q: "What is 'fado vadio'?", options: ["Professional fado", "Amateur/spontaneous fado in restaurants", "Religious fado", "Modern fado"], a: "Amateur/spontaneous fado in restaurants" },
            { q: "Coimbra fado differs from Lisbon fado in that it's traditionally sung by:", options: ["Women only", "Male university students", "Professional singers only", "Children"], a: "Male university students" },
            { q: "What was Am√°lia Rodrigues' hit that reached #2 on US charts in 1952?", options: ["Gr√¢ndola Vila Morena", "April in Portugal (Coimbra)", "Fado Portugu√™s", "Lisboa Antiga"], a: "April in Portugal (Coimbra)" },
            
            // Traditions & Festivals
            { q: "What happens on the night of June 12th in Lisbon?", options: ["Christmas Eve", "Santo Ant√≥nio festivities", "Carnival", "Easter celebrations"], a: "Santo Ant√≥nio festivities" },
            { q: "Which saint is the patron of Lisbon?", options: ["S√£o Jo√£o", "Santo Ant√≥nio", "S√£o Pedro", "S√£o Jorge"], a: "Santo Ant√≥nio" },
            { q: "What city celebrates S√£o Jo√£o with hammer-wielding revelers?", options: ["Lisbon", "Porto", "Coimbra", "Faro"], a: "Porto" },
            { q: "What do Portuguese traditionally eat on Christmas Eve?", options: ["Turkey", "Bacalhau (codfish)", "Roast pork", "Lamb"], a: "Bacalhau (codfish)" },
            { q: "The 'Queima das Fitas' is a festival for:", options: ["Burning old documents", "University students burning their faculty ribbons", "A fire festival", "Burning winter clothes"], a: "University students burning their faculty ribbons" },
            { q: "What is the Portuguese Carnival most famous for?", options: ["Masks in Venice style", "Samba in Ovar and Torres Vedras satire", "Bull running", "Religious processions"], a: "Samba in Ovar and Torres Vedras satire" },
            { q: "What is a 'marcha popular'?", options: ["A military parade", "Neighborhood parade with costumes and music", "A protest march", "A running race"], a: "Neighborhood parade with costumes and music" },
            { q: "What plant is traditionally associated with S√£o Jo√£o in Porto?", options: ["Roses", "Manjerico (basil) with love poems", "Carnations", "Lavender"], a: "Manjerico (basil) with love poems" },
            
            // Art, Architecture & Design
            { q: "What is 'Manueline' style?", options: ["A type of music", "Portuguese late Gothic architectural style", "A painting technique", "A writing style"], a: "Portuguese late Gothic architectural style" },
            { q: "What is the symbol most associated with Manueline architecture?", options: ["Lions", "Maritime motifs like ropes and armillary spheres", "Angels", "Flowers"], a: "Maritime motifs like ropes and armillary spheres" },
            { q: "What is an 'azulejo'?", options: ["A type of fish", "A painted ceramic tile", "A dance", "A musical instrument"], a: "A painted ceramic tile" },
            { q: "The Jer√≥nimos Monastery in Bel√©m was funded by:", options: ["Royal treasury", "Church donations", "Spice trade profits", "War spoils"], a: "Spice trade profits" },
            { q: "What UNESCO site in Sintra was a summer residence for Portuguese royalty?", options: ["Jer√≥nimos Monastery", "Pena Palace", "Tower of Bel√©m", "Alcoba√ßa Monastery"], a: "Pena Palace" },
            { q: "The 'cal√ßada portuguesa' is:", options: ["A type of bread", "Traditional limestone mosaic pavement", "A folk dance", "A ceramic style"], a: "Traditional limestone mosaic pavement" },
            { q: "What is Portugal's national symbol seen on the flag?", options: ["Eagle", "Lion", "Armillary sphere and shield", "Cross"], a: "Armillary sphere and shield" },
            
            // Sports & Other Culture
            { q: "What is Portugal's most popular sport?", options: ["Tennis", "Football (soccer)", "Rugby", "Basketball"], a: "Football (soccer)" },
            { q: "The 'Galo de Barcelos' (Barcelos Rooster) is a symbol of:", options: ["Portuguese cuisine", "Faith and justice (from a medieval legend)", "Royalty", "Maritime history"], a: "Faith and justice (from a medieval legend)" },
            { q: "What is 'azul' in the Portuguese flag meant to represent?", options: ["The sea", "There is no blue in the Portuguese flag", "The sky", "Royalty"], a: "There is no blue in the Portuguese flag" },
            { q: "What colors are on the Portuguese flag?", options: ["Red, white, blue", "Green, red, and yellow (from the shield)", "Blue and white", "Red and gold"], a: "Green, red, and yellow (from the shield)" },
            { q: "What is 'F√°tima' famous for?", options: ["A football stadium", "Catholic pilgrimage site of Marian apparitions", "A wine region", "A historical battle"], a: "Catholic pilgrimage site of Marian apparitions" },
            { q: "What year did the apparitions at F√°tima occur?", options: ["1890", "1910", "1917", "1936"], a: "1917" },
            { q: "What is 'sete colinas' in reference to Lisbon?", options: ["Seven beaches", "Seven hills the city is built on", "Seven neighborhoods", "Seven monuments"], a: "Seven hills the city is built on" },
            { q: "What is the world's oldest bookshop, located in Lisbon?", options: ["Livraria Lello", "Livraria Bertrand", "Livraria Ferin", "Alfarrabista do Chiado"], a: "Livraria Bertrand" },
            { q: "Livraria Lello in Porto inspired which fictional location?", options: ["Narnia", "Hogwarts library", "Middle Earth", "Wonderland"], a: "Hogwarts library" },
            { q: "What export is Portugal famous for today (hint: not Ronaldo or port wine)?", options: ["Olive oil", "Cork (over 50% of world supply)", "Textiles", "Ceramics"], a: "Cork (over 50% of world supply)" },
            
            // ============================================
            // CATEGORY 4: CELEBRITIES & HISTORICAL FIGURES (50)
            // ============================================
            
            // Writers & Poets
            { q: "Who is considered Portugal's greatest poet, author of 'Os Lus√≠adas'?", options: ["Fernando Pessoa", "Lu√≠s de Cam√µes", "Jos√© Saramago", "E√ßa de Queir√≥s"], a: "Lu√≠s de Cam√µes" },
            { q: "How many heteronyms did Fernando Pessoa have approximately?", options: ["3", "12", "Over 70", "Just 1"], a: "Over 70" },
            { q: "Which of these is NOT one of Pessoa's three main heteronyms?", options: ["Alberto Caeiro", "Ricardo Reis", "√Ålvaro de Campos", "Ant√≥nio Mora"], a: "Ant√≥nio Mora" },
            { q: "Jos√© Saramago won the Nobel Prize in Literature in:", options: ["1988", "1995", "1998", "2002"], a: "1998" },
            { q: "Saramago was the first writer in which language to win the Nobel?", options: ["Spanish", "Portuguese", "Galician", "Catalan"], a: "Portuguese" },
            { q: "Why did Saramago move to the Canary Islands?", options: ["Tax reasons", "His book was blocked by the Portuguese government", "Health reasons", "Personal preference"], a: "His book was blocked by the Portuguese government" },
            { q: "Which Saramago novel features an epidemic of blindness?", options: ["The Gospel According to Jesus Christ", "Blindness", "The Stone Raft", "Baltasar and Blimunda"], a: "Blindness" },
            { q: "What is 'O Livro do Desassossego' (Book of Disquiet)?", options: ["A cookbook", "Pessoa's fragmentary prose masterpiece", "A travel guide", "A political manifesto"], a: "Pessoa's fragmentary prose masterpiece" },
            { q: "Pessoa's heteronym Alberto Caeiro was described as:", options: ["An engineer from Glasgow", "A simple shepherd with no formal education", "A doctor who loved classical poetry", "A naval officer"], a: "A simple shepherd with no formal education" },
            { q: "√Ålvaro de Campos was influenced by which American poet?", options: ["Emily Dickinson", "Walt Whitman", "Robert Frost", "Edgar Allan Poe"], a: "Walt Whitman" },
            { q: "In which Lisbon caf√© did Fernando Pessoa often write?", options: ["Caf√© A Brasileira", "Past√©is de Bel√©m", "Martinho da Arcada", "Both A Brasileira and Martinho da Arcada"], a: "Both A Brasileira and Martinho da Arcada" },
            { q: "What was the name of the modernist magazine Pessoa helped found in 1915?", options: ["Presen√ßa", "Orpheu", "Contempor√¢nea", "Seara Nova"], a: "Orpheu" },
            
            // Musicians & Artists
            { q: "Who is known as the 'Queen of Fado'?", options: ["Dulce Pontes", "Mariza", "Am√°lia Rodrigues", "Ana Moura"], a: "Am√°lia Rodrigues" },
            { q: "What rumor surrounded Am√°lia Rodrigues after the Carnation Revolution?", options: ["She fled Portugal", "She was accused of collaborating with the dictatorship", "She retired immediately", "She joined politics"], a: "She was accused of collaborating with the dictatorship" },
            { q: "What did Am√°lia secretly do during the Salazar regime?", options: ["Spied for PIDE", "Funded the Portuguese Communist Party", "Wrote political songs", "Left the country"], a: "Funded the Portuguese Communist Party" },
            { q: "What was Carlos Paredes famous for playing?", options: ["Fado singing", "Portuguese guitar instrumentals", "Piano", "Violin"], a: "Portuguese guitar instrumentals" },
            { q: "Which contemporary fadista has won a Latin Grammy?", options: ["Cristina Branco", "Mariza", "Dulce Pontes", "Carminho"], a: "Mariza" },
            { q: "Paula Rego is a famous Portuguese:", options: ["Singer", "Visual artist and painter", "Writer", "Architect"], a: "Visual artist and painter" },
            { q: "Which Portuguese painter is known for 'Pain√©is de S√£o Vicente'?", options: ["Amadeo de Souza-Cardoso", "Nuno Gon√ßalves", "Almada Negreiros", "Vieira da Silva"], a: "Nuno Gon√ßalves" },
            
            // Sports Figures
            { q: "How many international goals has Cristiano Ronaldo scored (as of 2024)?", options: ["Over 100", "Over 120", "Over 140", "Over 160"], a: "Over 140" },
            { q: "How many Ballon d'Or awards has Ronaldo won?", options: ["3", "4", "5", "7"], a: "5" },
            { q: "Cristiano Ronaldo was born on which Portuguese island?", options: ["Azores", "Madeira", "Porto Santo", "Mainland Portugal"], a: "Madeira" },
            { q: "In which year did Portugal win their first European Championship?", options: ["2004", "2012", "2016", "2020"], a: "2016" },
            { q: "Who scored the winning goal in the Euro 2016 final?", options: ["Cristiano Ronaldo", "Nani", "√âder", "Pepe"], a: "√âder" },
            { q: "Eus√©bio, the 'Black Panther', was born in:", options: ["Portugal", "Mozambique", "Angola", "Brazil"], a: "Mozambique" },
            { q: "What record does Ronaldo hold for international caps?", options: ["Most goals", "Most assists", "Most appearances (over 200)", "Most World Cup goals"], a: "Most appearances (over 200)" },
            { q: "Lu√≠s Figo controversially transferred from Barcelona to:", options: ["Manchester United", "Real Madrid", "Inter Milan", "Juventus"], a: "Real Madrid" },
            { q: "Which Portuguese footballer is nicknamed 'CR7'?", options: ["Lu√≠s Figo", "Eus√©bio", "Cristiano Ronaldo", "Ricardo Carvalho"], a: "Cristiano Ronaldo" },
            
            // Political Figures
            { q: "Who was Portugal's first democratically elected Prime Minister after 1974?", options: ["Ramalho Eanes", "M√°rio Soares", "An√≠bal Cavaco Silva", "Francisco S√° Carneiro"], a: "M√°rio Soares" },
            { q: "Who became the first civilian President after the Carnation Revolution?", options: ["Ant√≥nio de Sp√≠nola", "Ramalho Eanes", "M√°rio Soares", "Am√©rico Tom√°s"], a: "Ramalho Eanes" },
            { q: "Ant√≥nio Guterres, before becoming UN Secretary-General, was:", options: ["Portugal's President", "Portugal's Prime Minister", "EU Commissioner", "NATO Secretary"], a: "Portugal's Prime Minister" },
            { q: "Who wrote 'Portugal and the Future', the book that helped spark the revolution?", options: ["Salgueiro Maia", "Ant√≥nio de Sp√≠nola", "Otelo Saraiva de Carvalho", "M√°rio Soares"], a: "Ant√≥nio de Sp√≠nola" },
            { q: "Aristides de Sousa Mendes was a Portuguese diplomat who:", options: ["Founded the UN", "Saved thousands of Jews by issuing visas against orders", "Discovered Brazil", "Led the Carnation Revolution"], a: "Saved thousands of Jews by issuing visas against orders" },
            { q: "How many visas did Sousa Mendes issue to refugees in 1940?", options: ["Hundreds", "About 10,000", "About 30,000", "About 100,000"], a: "About 30,000" },
            { q: "What happened to Sousa Mendes after he saved refugees?", options: ["He was promoted", "He was dismissed and died in poverty", "He became President", "He fled to America"], a: "He was dismissed and died in poverty" },
            { q: "Who was the Bishop of Porto exiled for criticizing Salazar?", options: ["D. Ant√≥nio Ferreira Gomes", "D. Manuel Gon√ßalves Cerejeira", "D. Jos√© da Cruz Policarpo", "D. Ant√≥nio Ribeiro"], a: "D. Ant√≥nio Ferreira Gomes" },
            
            // Other Notable Figures
            { q: "Who is considered the founder of modern Portuguese prose?", options: ["Cam√µes", "E√ßa de Queir√≥s", "Fernando Pessoa", "Gil Vicente"], a: "E√ßa de Queir√≥s" },
            { q: "Sophia de Mello Breyner Andresen was a famous Portuguese:", options: ["Painter", "Poet and writer", "Singer", "Actress"], a: "Poet and writer" },
            { q: "What did Maria de Medeiros, famous actress, direct about the Carnation Revolution?", options: ["April Captains (Capit√£es de Abril)", "Blindness", "Am√°lia", "The Letter"], a: "April Captains (Capit√£es de Abril)" },
            { q: "Who was the first woman buried in Portugal's National Pantheon?", options: ["Am√°lia Rodrigues", "Sophia de Mello Breyner", "Maria II", "Florbela Espanca"], a: "Am√°lia Rodrigues" },
            { q: "Manoel de Oliveira holds the record for:", options: ["Oldest active film director (directing until age 106)", "Most Oscar nominations", "Most Portuguese films", "Longest film ever made"], a: "Oldest active film director (directing until age 106)" },
            { q: "Which Portuguese navigator has a bridge named after him in Lisbon?", options: ["Bartolomeu Dias", "Pedro √Ålvares Cabral", "Vasco da Gama", "Ferdinand Magellan"], a: "Vasco da Gama" },
            
            // Additional questions
            { q: "What is the longest river entirely within Portugal?", options: ["Tagus", "Douro", "Mondego", "Guadiana"], a: "Mondego" },
            { q: "What Portuguese word means 'small polished stone' and names decorative tiles?", options: ["Mosaico", "Cer√¢mica", "Azulejo", "Pedra"], a: "Azulejo" },
            { q: "The Portuguese word 'obrigado' literally means:", options: ["Thank you", "Obligated/indebted", "Hello", "Please"], a: "Obligated/indebted" },
            { q: "What is the Algarve famous for?", options: ["Mountains", "Beaches and tourism", "Heavy industry", "Wine production"], a: "Beaches and tourism" },
            { q: "What did Portugal export that funded the Jer√≥nimos Monastery?", options: ["Gold", "Pepper and spices", "Wine", "Cork"], a: "Pepper and spices" },
            { q: "The 'Torre de Bel√©m' was built to defend which city?", options: ["Porto", "Lisbon", "Coimbra", "Faro"], a: "Lisbon" },
            { q: "What is 'past√©is de Bel√©m' versus 'pastel de nata'?", options: ["Same thing", "Past√©is de Bel√©m is the original from one bakery", "Different recipes", "Different sizes"], a: "Past√©is de Bel√©m is the original from one bakery" },
            { q: "Which Portuguese queen is known as 'The Holy Queen'?", options: ["Queen Maria I", "Queen Isabel", "Queen Leonor", "Queen Catarina"], a: "Queen Isabel" },
            { q: "What is the 'personal infinitive' unique to Portuguese?", options: ["A verb form with personal endings on infinitives", "A type of pronoun", "A conjugation mistake", "An archaic form"], a: "A verb form with personal endings on infinitives" },
            { q: "What is the Douro Valley famous for producing?", options: ["Cork", "Port wine and wine grapes", "Olives", "Citrus fruits"], a: "Port wine and wine grapes" },
            { q: "The term 'Age of Discovery' in Portuguese is:", options: ["Idade do Ouro", "√âpoca das Descobertas", "Tempo Imperial", "Era Colonial"], a: "√âpoca das Descobertas" },
            { q: "What is 'bacalhau √† Br√°s'?", options: ["Grilled cod", "Shredded cod with eggs and fried potatoes", "Cod soup", "Raw cod"], a: "Shredded cod with eggs and fried potatoes" },
            { q: "The newspaper 'Di√°rio de Not√≠cias' was founded in:", options: ["1764", "1864", "1910", "1974"], a: "1864" },
            { q: "What is the 'Est√°dio da Luz' in Lisbon?", options: ["A concert hall", "Benfica's football stadium", "A museum", "A shopping center"], a: "Benfica's football stadium" },
            { q: "Which Portuguese city is nicknamed 'The Invincible City'?", options: ["Lisbon", "Porto", "Coimbra", "Guimar√£es"], a: "Porto" },
            { q: "What event does Portugal celebrate on December 1st?", options: ["Independence Day (from Spain)", "Republic Day", "Christmas Eve", "Discovery Day"], a: "Independence Day (from Spain)" },
            { q: "The 'Carnation Revolution' is also known as:", options: ["The Red Revolution", "The 25th of April", "The Peaceful Coup", "The Student Revolution"], a: "The 25th of April" },
            { q: "What Portuguese word describes the feeling of cozy comfort?", options: ["Saudade", "Aconchego", "Desenrascan√ßo", "Cafun√©"], a: "Aconchego" },
            { q: "Which treaty in 1386 created the world's oldest alliance (Portugal-England)?", options: ["Treaty of Tordesillas", "Treaty of Windsor", "Treaty of Lisbon", "Treaty of Methuen"], a: "Treaty of Windsor" },
            { q: "What is 'bacalhau √† Gomes de S√°'?", options: ["Fried cod", "Cod casserole with potatoes, onions, and olives", "Cod soup", "Grilled cod"], a: "Cod casserole with potatoes, onions, and olives" },
            { q: "The 'Marqu√™s de Pombal' was famous for:", options: ["Discovering Brazil", "Rebuilding Lisbon after the 1755 earthquake", "Writing Os Lus√≠adas", "Leading the Carnation Revolution"], a: "Rebuilding Lisbon after the 1755 earthquake" },
            { q: "What is 'A Portuguesa'?", options: ["A newspaper", "The Portuguese national anthem", "A folk dance", "A type of bread"], a: "The Portuguese national anthem" },
            { q: "Portugal's Day (June 10th) also commemorates the death of:", options: ["Salazar", "Lu√≠s de Cam√µes", "Fernando Pessoa", "Vasco da Gama"], a: "Lu√≠s de Cam√µes" },
            { q: "What is 'Feijoada √† transmontana'?", options: ["Fish stew", "Bean and meat stew from Tr√°s-os-Montes", "Seafood soup", "Vegetable dish"], a: "Bean and meat stew from Tr√°s-os-Montes" },
            { q: "What is the 'Prova Oral' famous Portuguese TV show about?", options: ["Cooking", "Interviewing celebrities about their lives", "Sports", "Music"], a: "Interviewing celebrities about their lives" },
            { q: "What is 'Benfica vs Sporting' rivalry called?", options: ["O Cl√°ssico", "O D√©rbi", "O D√©rbi de Lisboa", "A Rivalidade"], a: "O D√©rbi de Lisboa" },
            { q: "What is Portugal's westernmost point, the 'end of the world'?", options: ["Sagres", "Cabo da Roca", "Sintra", "Cascais"], a: "Cabo da Roca" },
            { q: "What does 'bica' mean in Lisbon?", options: ["A sandwich", "An espresso coffee", "A tram", "A bridge"], a: "An espresso coffee" },
            { q: "In Porto, the same espresso is called:", options: ["Bica", "Cimbalino", "Caf√©", "Expresso"], a: "Cimbalino" }
        ];

        // Difficulty settings per level - 3 rounds per level, 10 targets each
        // Each round increases speed by 20%
        const LEVEL_CONFIG = {
            1: { baseSpeed: 8400, spawnRate: 2100, targetsPerRound: 10, rounds: 3, tempo: 280 },
            2: { baseSpeed: 6300, spawnRate: 1750, targetsPerRound: 10, rounds: 3, tempo: 220 },
            3: { baseSpeed: 4900, spawnRate: 1400, targetsPerRound: 10, rounds: 3, tempo: 180 },
            4: { baseSpeed: 3500, spawnRate: 1050, targetsPerRound: 10, rounds: 3, tempo: 140 },
            5: { targetsPerRound: 10, rounds: 3, mode: 'dictation' }
        };

        const MAX_ITEMS_ON_SCREEN = 5;

        // Anti-theft protection
        (function () {
            'use strict';
            // Disable right-click
            document.addEventListener('contextmenu', e => e.preventDefault());
            // Disable dev tool shortcuts
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C', 'K'].includes(e.key)) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                }
            });
            // Console warning
            console.clear();
            console.log('%c‚ö†Ô∏è STOP!', 'color: red; font-size: 50px; font-weight: bold;');
            console.log('%cüêü Bacalhau √† Bl√°st! ¬© 2024 - All Rights Reserved', 'font-size: 16px; color: #006600;');
            console.log('%cUnauthorized copying or distribution is prohibited.', 'font-size: 14px;');
        })();

        // Game State
        const gameState = {
            score: 0, lives: 3, level: 1, round: 1,
            targetItem: '', isPlaying: false, isPaused: false,
            isInChallenge: false, isDictationMode: false,
            currentChallenge: null, isDoubleDown: false,
            letterSpeed: 10000, spawnRate: 2500,
            itemsPerRound: 10, itemsCorrect: 0,
            itemPool: [], activeItems: [], activeLasers: [],
            spawnInterval: null, shipX: 50,
            canShoot: true, shootCooldown: 250,
            currentUser: null, musicEnabled: true,
            challengeAudioEnabled: true, currentTrack: 'lexica',
            bgMusicVolume: 0.5, challengeMusicVolume: 0.5,
            externalAudio: null, externalTracks: [],
            challengeFreezeTime: 0,
            // Timer system
            roundTimer: 15, timerInterval: null, timeoutCount: 0,
            touchHurts: false, speedPenalty: false, baseLetterSpeed: 10000
        };

        // Audio
        let audioContext;
        let musicInterval = null;
        let musicStep = 0;

        // Data storage
        let gameData = {
            players: {}
        };

        // DOM Elements
        const el = {
            loginScreen: document.getElementById('loginScreen'),
            usernameInput: document.getElementById('usernameInput'),
            loginBtn: document.getElementById('loginBtn'),
            viewScoresBtn: document.getElementById('viewScoresBtn'),
            importBtn: document.getElementById('importBtn'),
            importFile: document.getElementById('importFile'),
            titleScreen: document.getElementById('titleScreen'),
            playerName: document.getElementById('playerName'),
            levelSelect: document.getElementById('levelSelect'),
            startBtn: document.getElementById('startBtn'),
            statsBtn: document.getElementById('statsBtn'),
            scoresBtn: document.getElementById('scoresBtn'),
            exportBtn: document.getElementById('exportBtn'),
            changeUserBtn: document.getElementById('changeUserBtn'),
            statsScreen: document.getElementById('statsScreen'),
            statsPlayerName: document.getElementById('statsPlayerName'),
            statsContainer: document.getElementById('statsContainer'),
            statsBackBtn: document.getElementById('statsBackBtn'),
            scoreboardScreen: document.getElementById('scoreboardScreen'),
            scoreboardList: document.getElementById('scoreboardList'),
            scoreboardBackBtn: document.getElementById('scoreboardBackBtn'),
            scoreDisplay: document.getElementById('score'),
            roundDisplay: document.getElementById('round'),
            modeDisplay: document.getElementById('modeDisplay'),
            livesDisplay: document.getElementById('livesDisplay'),
            pauseBtn: document.getElementById('pauseBtn'),
            musicToggle: document.getElementById('musicToggle'),
            playlistBtn: document.getElementById('playlistBtn'),
            playlistMenu: document.getElementById('playlistMenu'),
            playlistClose: document.getElementById('playlistClose'),
            playlistTracks: document.getElementById('playlistTracks'),
            challengeMusicToggle: document.getElementById('challengeMusicToggle'),
            bgVolumeSlider: document.getElementById('bgVolumeSlider'),
            challengeVolumeSlider: document.getElementById('challengeVolumeSlider'),
            targetLabel: document.getElementById('targetLabel'),
            targetLetter: document.getElementById('targetLetter'),
            speakBtn: document.getElementById('speakBtn'),
            gameArea: document.getElementById('gameArea'),
            spaceship: document.getElementById('spaceship'),
            shootHint: document.getElementById('shootHint'),
            pauseOverlay: document.getElementById('pauseOverlay'),
            resumeBtn: document.getElementById('resumeBtn'),
            quitBtn: document.getElementById('quitBtn'),
            levelComplete: document.getElementById('levelComplete'),
            levelCompleteTitle: document.getElementById('levelCompleteTitle'),
            levelCompleteText: document.getElementById('levelCompleteText'),
            nextLevelIntro: document.getElementById('nextLevelIntro'),
            starsEarned: document.getElementById('starsEarned'),
            continueBtn: document.getElementById('continueBtn'),
            gameComplete: document.getElementById('gameComplete'),
            winScore: document.getElementById('winScore'),
            winStars: document.getElementById('winStars'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            winMenuBtn: document.getElementById('winMenuBtn'),
            gameOver: document.getElementById('gameOver'),
            finalScore: document.getElementById('finalScore'),
            retryBtn: document.getElementById('retryBtn'),
            gameOverMenuBtn: document.getElementById('gameOverMenuBtn'),
            gameContainer: document.getElementById('gameContainer'),
            // Challenge modal
            challengeModal: document.getElementById('challengeModal'),
            challengeQuestion: document.getElementById('challengeQuestion'),
            challengeOptions: document.getElementById('challengeOptions'),
            challengeResult: document.getElementById('challengeResult'),
            challengeContinueBtn: document.getElementById('challengeContinueBtn'),
            doubleDownSection: document.getElementById('doubleDownSection'),
            returnBtn: document.getElementById('returnBtn'),
            doubleDownBtn: document.getElementById('doubleDownBtn'),
            // Dictation mode
            dictationArea: document.getElementById('dictationArea'),
            dictationPrompt: document.getElementById('dictationPrompt'),
            dictationInput: document.getElementById('dictationInput'),
            dictationSubmitBtn: document.getElementById('dictationSubmitBtn'),
            dictationSpeakBtn: document.getElementById('dictationSpeakBtn'),
            beatsMeBtn: document.getElementById('beatsMeBtn'),
            // Timer
            timerSword: document.getElementById('timerSword'),
            powerBar: document.getElementById('powerBar'),
            powerTime: document.getElementById('powerTime'),
            penaltyIndicator: document.getElementById('penaltyIndicator')
        };

        // Initialize
        function init() {
            createStarfield();
            startShootingStars();
            loadData();
            setupEventListeners();
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
            }
            
            // Setup challenge music error handling
            const challengeMusic = document.getElementById('challengeMusic');
            if (challengeMusic) {
                challengeMusic.onerror = (e) => {
                    console.log('Challenge music file not found');
                };
                challengeMusic.oncanplaythrough = () => {
                    console.log('Challenge music loaded successfully:', challengeMusic.currentSrc);
                };
            }
            
            // Start background music on menu (requires user interaction first)
            document.addEventListener('click', function startMusicOnce() {
                if (gameState.musicEnabled) {
                    initAudio();
                    // Default is 'lexica' - try to play it, fallback to 8bit if not found
                    if (gameState.currentTrack === '8bit') {
                        startMusic();
                    } else {
                        // For initial load, directly try the lexica file
                        gameState.externalTracks = [{ id: 'lexica', name: 'üé∏ Press X Twice', file: 'ES_Press X Twice - Lexica.mp3' }];
                        playExternalTrack(gameState.currentTrack);
                    }
                }
                document.removeEventListener('click', startMusicOnce);
            }, { once: true });
        }

        function createStarfield() {
            const starfield = document.getElementById('starfield');
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = 'bg-star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                starfield.appendChild(star);
            }
        }

        function startShootingStars() {
            const starfield = document.getElementById('starfield');

            function createShootingStar() {
                const star = document.createElement('div');
                star.className = 'shooting-star';
                // Spawn anywhere across the top and left areas
                star.style.left = (Math.random() * 100) + '%';
                star.style.top = (Math.random() * 60) + '%';
                starfield.appendChild(star);

                // Remove after animation completes
                setTimeout(() => star.remove(), 1200);

                // Schedule next shooting star (occasional: 2-5 seconds)
                setTimeout(createShootingStar, 2000 + Math.random() * 3000);
            }
            
            // Maritime icon shooting across occasionally
            function createKpopStar() {
                const maritimeIcons = ['‚öì', 'üß≠', '‚õµ', 'ü¶ê', 'üêö', 'üåä', 'üêü', '‚≠ê', 'üåü', '‚ú®'];
                const icon = document.createElement('div');
                icon.className = 'kpop-shooting-star';
                icon.textContent = maritimeIcons[Math.floor(Math.random() * maritimeIcons.length)];
                icon.style.left = '-5%';
                icon.style.top = (Math.random() * 60) + '%';
                starfield.appendChild(icon);
                
                setTimeout(() => icon.remove(), 3000);
                setTimeout(createKpopStar, 3000 + Math.random() * 4000);
            }

            // Start first shooting star after a short delay
            setTimeout(createShootingStar, 1000);
            // Start maritime icons slightly later
            setTimeout(createKpopStar, 2000);
        }

        // Data Management
        function loadData() {
            try {
                const saved = localStorage.getItem('koreanBlasterData');
                if (saved) gameData = JSON.parse(saved);
            } catch (e) {
                console.log('No saved data');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('koreanBlasterData', JSON.stringify(gameData));
            } catch (e) {
                console.log('Could not save data');
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(gameData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'korean-blaster-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.players) {
                        // Merge data
                        for (const player in imported.players) {
                            if (!gameData.players[player]) {
                                gameData.players[player] = imported.players[player];
                            } else {
                                // Merge history
                                const existing = gameData.players[player];
                                const incoming = imported.players[player];
                                existing.history = [...existing.history, ...incoming.history];
                                existing.gamesPlayed = existing.history.length;
                                existing.bestScore = Math.max(existing.bestScore, incoming.bestScore);
                            }
                        }
                        saveData();
                        alert('Data imported successfully!');
                    }
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        function saveGameResult(score, level) {
            if (!gameState.currentUser) return;
            const player = gameState.currentUser;
            if (!gameData.players[player]) {
                gameData.players[player] = { gamesPlayed: 0, bestScore: 0, history: [] };
            }
            const p = gameData.players[player];
            p.gamesPlayed++;
            p.bestScore = Math.max(p.bestScore, score);
            p.history.push({
                score: score,
                level: level,
                date: new Date().toISOString().split('T')[0]
            });
            // Keep only last 50 games
            if (p.history.length > 50) p.history = p.history.slice(-50);
            saveData();
        }

        function getTopScores() {
            const scores = [];
            for (const player in gameData.players) {
                const p = gameData.players[player];
                if (p.bestScore > 0) {
                    scores.push({ name: player, score: p.bestScore, games: p.gamesPlayed });
                }
            }
            return scores.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        // Audio System
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Retro Arcade Sound System (matching Word Warrior)
        function playSound(type) {
            try {
                initAudio();
                const ctx = audioContext;
                const now = ctx.currentTime;

                if (type === 'blast') {
                    // Laser blast - sweeping square wave + noise burst
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.exponentialRampToValueAtTime(200, now + 0.15);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.15);

                    // Add noise burst
                    const bufferSize = ctx.sampleRate * 0.08;
                    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                    const noise = ctx.createBufferSource();
                    const noiseGain = ctx.createGain();
                    const noiseFilter = ctx.createBiquadFilter();
                    noise.buffer = buffer;
                    noiseFilter.type = 'highpass';
                    noiseFilter.frequency.value = 2000;
                    noiseGain.gain.setValueAtTime(0.08, now);
                    noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
                    noise.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(ctx.destination);
                    noise.start(now);
                    noise.stop(now + 0.08);

                } else if (type === 'correct') {
                    // Victory arpeggio - rising tones
                    const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
                    notes.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'square';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.12, now + i * 0.08);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.15);
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(now + i * 0.08);
                        osc.stop(now + i * 0.08 + 0.15);
                    });

                } else if (type === 'wrong') {
                    // Error buzz - descending dissonant tone
                    const osc1 = ctx.createOscillator();
                    const osc2 = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc1.type = 'sawtooth';
                    osc2.type = 'square';
                    osc1.frequency.setValueAtTime(180, now);
                    osc1.frequency.exponentialRampToValueAtTime(80, now + 0.3);
                    osc2.frequency.setValueAtTime(185, now);
                    osc2.frequency.exponentialRampToValueAtTime(75, now + 0.3);
                    gain.gain.setValueAtTime(0.12, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc1.connect(gain);
                    osc2.connect(gain);
                    gain.connect(ctx.destination);
                    osc1.start(now);
                    osc2.start(now);
                    osc1.stop(now + 0.3);
                    osc2.stop(now + 0.3);

                } else if (type === 'explosion') {
                    // Big explosion - noise burst with pitch down
                    const bufferSize = ctx.sampleRate * 0.4;
                    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                    const noise = ctx.createBufferSource();
                    const noiseGain = ctx.createGain();
                    const filter = ctx.createBiquadFilter();
                    noise.buffer = buffer;
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(4000, now);
                    filter.frequency.exponentialRampToValueAtTime(200, now + 0.4);
                    noiseGain.gain.setValueAtTime(0.25, now);
                    noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                    noise.connect(filter);
                    filter.connect(noiseGain);
                    noiseGain.connect(ctx.destination);
                    noise.start(now);
                    noise.stop(now + 0.4);

                    // Add bass thump
                    const osc = ctx.createOscillator();
                    const oscGain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(30, now + 0.2);
                    oscGain.gain.setValueAtTime(0.3, now);
                    oscGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    osc.connect(oscGain);
                    oscGain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.2);

                } else if (type === 'challenge') {
                    // Mystical challenge appear sound
                    const notes = [392, 523, 659, 784]; // G4, C5, E5, G5
                    notes.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'triangle';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0, now + i * 0.1);
                        gain.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.3);
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(now + i * 0.1);
                        osc.stop(now + i * 0.1 + 0.3);
                    });

                } else if (type === 'powerup') {
                    // Life gained sound - triumphant rising
                    const notes = [523, 659, 784, 1047, 1319]; // C5, E5, G5, C6, E6
                    notes.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'square';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.1, now + i * 0.06);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.06 + 0.2);
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(now + i * 0.06);
                        osc.stop(now + i * 0.06 + 0.2);
                    });

                } else if (type === 'levelup' || type === 'win') {
                    // Level up / Win fanfare
                    const notes = [523, 659, 784, 1047, 1319]; // C5, E5, G5, C6, E6
                    notes.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'square';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.12, now + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.25);
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(now + i * 0.1);
                        osc.stop(now + i * 0.1 + 0.25);
                    });

                } else if (type === 'timerTick') {
                    // Urgent tick sound for low timer
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = 880;
                    gain.gain.setValueAtTime(0.08, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.05);

                } else if (type === 'timeout') {
                    // Timeout warning - alarming sound
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.exponentialRampToValueAtTime(220, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch (e) { console.log('Audio error:', e); }
        }

        // Retro Music System - Different music per level!
        const MUSIC_DATA = {
            1: { // Level 1: Friendly, simple, slow
                bass: [65.41, 65.41, 82.41, 82.41, 73.42, 73.42, 82.41, 65.41],
                melody: [261.63, 293.66, 329.63, 293.66, 261.63, 329.63, 293.66, 261.63],
                wave: 'triangle'
            },
            2: { // Level 2: Minor key, slightly tense
                bass: [55.00, 55.00, 73.42, 73.42, 65.41, 65.41, 73.42, 55.00],
                melody: [220.00, 261.63, 293.66, 261.63, 246.94, 293.66, 261.63, 220.00],
                wave: 'square'
            },
            3: { // Level 3: Energetic, faster feel
                bass: [82.41, 98.00, 82.41, 110.00, 82.41, 98.00, 110.00, 82.41],
                melody: [329.63, 392.00, 440.00, 392.00, 349.23, 440.00, 392.00, 329.63],
                wave: 'sawtooth'
            },
            4: { // Level 4: Intense, dramatic, urgent
                bass: [110.00, 130.81, 110.00, 146.83, 110.00, 130.81, 146.83, 110.00],
                melody: [440.00, 523.25, 587.33, 523.25, 493.88, 587.33, 523.25, 440.00],
                wave: 'square'
            }
        };

        function startMusic() {
            if (!gameState.musicEnabled || musicInterval) return;
            initAudio();
            musicStep = 0;

            const level = gameState.level || 1;
            const music = MUSIC_DATA[level];
            const config = LEVEL_CONFIG[level];
            const tempo = config.tempo;

            musicInterval = setInterval(() => {
                if (gameState.isPaused || !gameState.isPlaying) return;

                const now = audioContext.currentTime;
                const noteLength = tempo / 1000 * 0.8;

                // Bass - punchy low end
                const bass = audioContext.createOscillator();
                const bassGain = audioContext.createGain();
                bass.type = 'square';
                bass.frequency.setValueAtTime(music.bass[musicStep % music.bass.length], now);
                bassGain.gain.setValueAtTime(0.1, now);
                bassGain.gain.exponentialRampToValueAtTime(0.01, now + noteLength);
                bass.connect(bassGain);
                bassGain.connect(audioContext.destination);
                bass.start(now);
                bass.stop(now + noteLength);

                // Melody (every other beat for levels 1-2, every beat for 3-4)
                const melodyFrequency = (level <= 2) ? 2 : 1;
                if (musicStep % melodyFrequency === 0) {
                    const mel = audioContext.createOscillator();
                    const melGain = audioContext.createGain();
                    mel.type = music.wave;
                    const melIndex = (level <= 2) ? (musicStep / 2) : musicStep;
                    mel.frequency.setValueAtTime(music.melody[melIndex % music.melody.length], now);
                    melGain.gain.setValueAtTime(0.07, now);
                    melGain.gain.exponentialRampToValueAtTime(0.01, now + noteLength * 0.9);
                    mel.connect(melGain);
                    melGain.connect(audioContext.destination);
                    mel.start(now);
                    mel.stop(now + noteLength * 0.9);
                }

                // Hi-hat - faster on higher levels
                const hatBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.03, audioContext.sampleRate);
                const hatData = hatBuffer.getChannelData(0);
                for (let i = 0; i < hatData.length; i++) hatData[i] = Math.random() * 2 - 1;
                const hat = audioContext.createBufferSource();
                hat.buffer = hatBuffer;
                const hatGain = audioContext.createGain();
                const hatVolume = 0.03 + (level * 0.01); // Louder hats on higher levels
                hatGain.gain.setValueAtTime(hatVolume, now);
                hatGain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
                hat.connect(hatGain);
                hatGain.connect(audioContext.destination);
                hat.start(now);

                // Kick drum on beats 1 and 5 (every 4 steps) for levels 3-4
                if (level >= 3 && musicStep % 4 === 0) {
                    const kick = audioContext.createOscillator();
                    const kickGain = audioContext.createGain();
                    kick.type = 'sine';
                    kick.frequency.setValueAtTime(150, now);
                    kick.frequency.exponentialRampToValueAtTime(30, now + 0.1);
                    kickGain.gain.setValueAtTime(0.3, now);
                    kickGain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    kick.connect(kickGain);
                    kickGain.connect(audioContext.destination);
                    kick.start(now);
                    kick.stop(now + 0.1);
                }

                musicStep++;
            }, tempo);
        }

        function stopMusic() {
            if (musicInterval) {
                clearInterval(musicInterval);
                musicInterval = null;
            }
        }

        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            el.musicToggle.textContent = gameState.musicEnabled ? 'üîä' : 'üîá';
            el.musicToggle.classList.toggle('muted', !gameState.musicEnabled);
            if (!gameState.musicEnabled) {
                stopMusic();
                stopExternalAudio();
            } else if (gameState.isPlaying && !gameState.isPaused) {
                if (gameState.currentTrack === '8bit') {
                    startMusic();
                } else {
                    playExternalTrack(gameState.currentTrack);
                }
            }
        }

        function toggleChallengeAudio() {
            gameState.challengeAudioEnabled = !gameState.challengeAudioEnabled;
            el.challengeMusicToggle.textContent = gameState.challengeAudioEnabled ? 'üîä' : 'üîá';
            el.challengeMusicToggle.classList.toggle('muted', !gameState.challengeAudioEnabled);
            
            // Toggle the actual challenge music
            const challengeMusic = document.getElementById('challengeMusic');
            if (challengeMusic) {
                if (gameState.challengeAudioEnabled) {
                    challengeMusic.volume = gameState.challengeMusicVolume;
                    challengeMusic.play().catch(e => {});
                } else {
                    challengeMusic.pause();
                }
            }
        }

        function openPlaylist() {
            // Pause the game when opening playlist
            if (gameState.isPlaying && !gameState.isPaused) {
                pauseGame();
            }
            el.playlistMenu.classList.remove('hidden');
            loadExternalTracks();
        }

        function closePlaylist() {
            el.playlistMenu.classList.add('hidden');
            // Resume game if it was playing
            if (gameState.isPlaying && gameState.isPaused) {
                resumeGame();
            }
        }

        function loadExternalTracks() {
            // Audio files are in the same folder as the game HTML
            // Only show tracks that actually exist
            const potentialTracks = [
                { id: 'lexica', name: 'üé∏ Press X Twice', file: 'ES_Press X Twice - Lexica.mp3' },
                { id: 'track1', name: 'üéµ Track 1', file: 'track1.mp3' },
                { id: 'track2', name: 'üéµ Track 2', file: 'track2.mp3' },
                { id: 'track3', name: 'üéµ Track 3', file: 'track3.mp3' },
                { id: 'music1', name: 'üéµ Music 1', file: 'music1.mp3' },
                { id: 'music2', name: 'üéµ Music 2', file: 'music2.mp3' },
                { id: 'music', name: 'üéµ Music', file: 'music.mp3' },
                { id: 'background', name: 'üéµ Background', file: 'background.mp3' },
                { id: 'fado', name: 'üé∏ Fado', file: 'fado.mp3' },
                { id: 'portuguese', name: 'üáµüáπ Portuguese', file: 'portuguese.mp3' }
            ];
            
            // Show loading state
            el.playlistTracks.innerHTML = '<p class="playlist-info">Detecting tracks...</p>';
            
            // Check which files exist
            detectExistingTracks(potentialTracks).then(detectedTracks => {
                gameState.externalTracks = detectedTracks;
                
                // Update playlist UI - show only detected tracks
                el.playlistTracks.innerHTML = '';
                
                if (detectedTracks.length === 0) {
                    el.playlistTracks.innerHTML = '<p class="playlist-info">No MP3 files found in folder</p>';
                } else {
                    detectedTracks.forEach(track => {
                        const btn = document.createElement('button');
                        btn.className = 'playlist-track';
                        if (gameState.currentTrack === track.id) btn.classList.add('active');
                        btn.dataset.track = track.id;
                        btn.textContent = track.name;
                        btn.onclick = () => selectTrack(track.id);
                        el.playlistTracks.appendChild(btn);
                    });
                }
            });
        }

        async function detectExistingTracks(candidates) {
            const detected = [];
            for (const track of candidates) {
                try {
                    const response = await fetch(track.file, { method: 'HEAD' });
                    if (response.ok) {
                        detected.push(track);
                    }
                } catch (e) {
                    // File doesn't exist, skip
                }
            }
            return detected;
        }

        function selectTrack(trackId) {
            // Update active state on all track buttons
            document.querySelectorAll('.playlist-track').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.track === trackId) btn.classList.add('active');
            });

            gameState.currentTrack = trackId;

            if (trackId === '8bit') {
                stopExternalAudio();
                if (gameState.musicEnabled && gameState.isPlaying && !gameState.isPaused) {
                    startMusic();
                }
            } else {
                stopMusic();
                if (gameState.musicEnabled) {
                    playExternalTrack(trackId);
                }
            }
        }

        function playExternalTrack(trackId) {
            const track = gameState.externalTracks.find(t => t.id === trackId);
            if (!track) {
                // Track not in detected list, try to play anyway (for initial load)
                const fallbackTrack = { id: trackId, file: 'ES_Press X Twice - Lexica.mp3' };
                playExternalTrackDirect(fallbackTrack);
                return;
            }
            playExternalTrackDirect(track);
        }

        function playExternalTrackDirect(track) {
            stopExternalAudio();
            
            console.log('Trying to play:', track.file);
            
            gameState.externalAudio = new Audio(track.file);
            gameState.externalAudio.loop = true;
            gameState.externalAudio.volume = gameState.bgMusicVolume;
            
            gameState.externalAudio.onerror = () => {
                console.log('Audio file not found:', track.file);
                // Fall back to 8-bit silently on initial load
                gameState.currentTrack = '8bit';
                document.querySelectorAll('.playlist-track').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.track === '8bit') btn.classList.add('active');
                });
                if (gameState.musicEnabled) startMusic();
            };
            
            gameState.externalAudio.play().catch(err => {
                console.log('External audio play failed:', err);
            });
        }

        function stopExternalAudio() {
            if (gameState.externalAudio) {
                gameState.externalAudio.pause();
                gameState.externalAudio.currentTime = 0;
                gameState.externalAudio = null;
            }
        }

        // Speech - Portuguese
        function speakItem(item, lang = 'pt-PT') {
            // Voice should work regardless of music toggle
            if ('speechSynthesis' in window) {
                let text;
                if (typeof item === 'object' && item !== null) {
                    text = item.word || item.char;
                } else {
                    text = item;
                }

                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.8;
                const voices = speechSynthesis.getVoices();
                const targetVoice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
                if (targetVoice) utterance.voice = targetVoice;
                speechSynthesis.speak(utterance);
            }
        }

        // Game Logic
        function getItemPool() {
            switch (gameState.level) {
                case 1:
                    return [...PT_SOUNDS];
                case 2:
                    return [...PT_WORDS];
                case 3:
                    return [...FALSE_FRIENDS];
                case 4:
                    // Return vocab tier based on round
                    if (gameState.round === 1) return [...PT_VOCAB_A1];
                    if (gameState.round === 2) return [...PT_VOCAB_A2];
                    return [...PT_VOCAB_B1B2];
                case 5:
                    return [...DICTATION_WORDS];
                default:
                    return [...PT_SOUNDS];
            }
        }

        function updateModeDisplay() {
            const modeNames = ['', 'SOUNDS', 'WORDS WITH SOUNDS', 'FALSE FRIENDS', 'LISTEN & FIND', 'DICTATION'];
            el.modeDisplay.textContent = `LVL ${gameState.level}: ${modeNames[gameState.level]}`;

            if (gameState.level === 1) {
                el.targetLabel.textContent = 'üéØ SHOOT THIS SOUND üéØ';
                el.targetLetter.classList.remove('hidden-letter');
            } else if (gameState.level === 2) {
                el.targetLabel.textContent = 'üéØ SHOOT WORD WITH SOUND üéØ';
                el.targetLetter.classList.remove('hidden-letter');
            } else if (gameState.level === 3) {
                el.targetLabel.textContent = 'üéØ SHOOT TRUE MEANING üéØ';
                el.targetLetter.classList.remove('hidden-letter');
            } else if (gameState.level === 4) {
                el.targetLabel.textContent = 'üîä LISTEN & SHOOT üîä';
                el.targetLetter.classList.add('hidden-letter');
            } else if (gameState.level === 5) {
                el.targetLabel.textContent = '‚úçÔ∏è TYPE PORTUGUESE ‚úçÔ∏è';
                el.targetLetter.classList.add('hidden-letter');
            }
        }

        function setNewTarget() {
            const pool = gameState.itemPool;
            const targetObj = pool[Math.floor(Math.random() * pool.length)];
            gameState.targetItem = targetObj;

            // Display based on level
            if (gameState.level === 1) {
                // Show IPA symbol, targets will show letter combinations
                el.targetLetter.textContent = targetObj.ipa || targetObj.char;
                el.targetLetter.classList.remove('hidden-letter');
                // Auto-speak the example word
                setTimeout(() => speakItem(targetObj.example || targetObj.char), 300);
            } else if (gameState.level === 2) {
                // Show IPA for the sound, shoot words containing it
                const soundObj = PT_SOUNDS.find(s => s.char === targetObj.sound);
                el.targetLetter.textContent = soundObj ? soundObj.ipa : targetObj.sound;
                el.targetLetter.classList.remove('hidden-letter');
                // Auto-speak the target word
                setTimeout(() => speakItem(targetObj.word), 300);
            } else if (gameState.level === 3) {
                // Show Portuguese word, shoot true meaning
                el.targetLetter.textContent = targetObj.word;
                el.targetLetter.classList.remove('hidden-letter');
                setTimeout(() => speakItem(targetObj.word), 300);
            } else if (gameState.level === 4) {
                // AUDIO ONLY - hide visual prompt, speak Portuguese word
                el.targetLetter.textContent = 'üîä LISTEN';
                el.targetLetter.classList.add('hidden-letter');
                // Speak the Portuguese word
                setTimeout(() => speakItem(targetObj.word), 300);
            }
        }

        function createFloatingItem() {
            if (!gameState.isPlaying || gameState.isPaused || gameState.isInChallenge) return;

            // Throttle: max 5 items on screen at once
            if (gameState.activeItems.length >= MAX_ITEMS_ON_SCREEN) return;

            // 10% chance to spawn a meteorite instead (but not if timer is low)
            if (Math.random() < 0.10 && gameState.roundTimer > 5) {
                createMeteorite();
                return;
            }

            const item = document.createElement('div');
            item.className = (gameState.level >= 3) ? 'floating-word' : 'floating-letter';

            // Force spawn target if timer is running low (< 10 seconds) and no target visible
            const hasTargetOnScreen = gameState.activeItems.some(el => {
                try {
                    const data = JSON.parse(el.dataset.item || '{}');
                    if (gameState.level === 1) return data.char === gameState.targetItem.char;
                    if (gameState.level === 2) return data.sound === gameState.targetItem.sound;
                    if (gameState.level === 3) return data.correct === gameState.targetItem.correct && !data.isFalseCognate;
                    if (gameState.level === 4) return data.word === gameState.targetItem.word;
                } catch(e) { return false; }
                return false;
            });
            
            // 35% base chance, but force target if timer < 10s and none visible
            const forceTarget = gameState.roundTimer < 10 && !hasTargetOnScreen;
            const isTarget = forceTarget || Math.random() < 0.35;
            const pool = gameState.itemPool;
            const contentObj = isTarget ? gameState.targetItem : pool[Math.floor(Math.random() * pool.length)];

            // Display and tooltip based on level
            if (gameState.level === 1) {
                // Level 1: Show letter combo, prompt shows IPA
                item.textContent = contentObj.char;
                item.dataset.meaning = contentObj.meaning;
                item.dataset.item = JSON.stringify(contentObj);
            } else if (gameState.level === 2) {
                // Level 2: Show word, prompt shows IPA of sound it contains
                item.textContent = contentObj.word;
                item.dataset.meaning = `contains "${contentObj.sound}" - ${contentObj.meaning}`;
                item.dataset.item = JSON.stringify(contentObj);
            } else if (gameState.level === 3) {
                // Level 3: False Friends
                // Must show: current target's correct answer AND its false cognate trap
                // Plus distractors from other words
                
                const targetWord = gameState.targetItem;
                const isTrueFriend = targetWord.correct === targetWord.false || targetWord.meaning === targetWord.false;
                
                if (isTarget) {
                    // Show the CORRECT answer for current target
                    item.textContent = targetWord.correct;
                    if (isTrueFriend) {
                        item.dataset.meaning = `‚úÖ TRUE FRIEND! ${targetWord.word} = ${targetWord.meaning}`;
                    } else {
                        item.dataset.meaning = `${targetWord.word} = ${targetWord.meaning}`;
                    }
                    item.dataset.item = JSON.stringify(targetWord);
                } else {
                    // 50% chance: show the FALSE cognate TRAP for current target
                    // 50% chance: show a distractor (correct answer from different word)
                    const showTrap = Math.random() < 0.5 && !isTrueFriend;
                    
                    if (showTrap) {
                        // Show the FALSE cognate (TRAP!) for the CURRENT target
                        item.textContent = targetWord.false;
                        item.dataset.meaning = `‚ö†Ô∏è FALSE FRIEND! ${targetWord.word} ‚â† ${targetWord.false}`;
                        item.dataset.item = JSON.stringify({...targetWord, isFalseCognate: true});
                        item.dataset.isFalseCognate = 'true';
                    } else {
                        // Show a distractor (correct answer from a DIFFERENT word)
                        let distractor = pool[Math.floor(Math.random() * pool.length)];
                        // Make sure it's not the same as current target
                        while (distractor.word === targetWord.word) {
                            distractor = pool[Math.floor(Math.random() * pool.length)];
                        }
                        const distractorIsTrueFriend = distractor.correct === distractor.false || distractor.meaning === distractor.false;
                        item.textContent = distractor.correct;
                        if (distractorIsTrueFriend) {
                            item.dataset.meaning = `‚úÖ TRUE FRIEND: ${distractor.word} = ${distractor.meaning}`;
                        } else {
                            item.dataset.meaning = `${distractor.word} = ${distractor.meaning}`;
                        }
                        item.dataset.item = JSON.stringify(distractor);
                    }
                }
            } else if (gameState.level === 4) {
                // Level 4: Show Portuguese word, target is meaning
                item.textContent = contentObj.word;
                item.dataset.meaning = contentObj.meaning;
                item.dataset.item = JSON.stringify(contentObj);
            }

            // Color pairs: [text color, glow color] - glow contrasts with text
            const colorPairs = [
                ['#00ff64', '#ffd700'],  // green text, gold glow
                ['#ff3333', '#00ffff'],  // red text, cyan glow
                ['#00ffff', '#ff66ff'],  // cyan text, pink glow
                ['#1e90ff', '#ffd700'],  // blue text, gold glow
                ['#ffff00', '#ff66ff'],  // yellow text, pink glow
                ['#ff66ff', '#00ffff'],  // pink text, cyan glow
                ['#ffd700', '#ff66ff'],  // gold text, pink glow
            ];
            const pair = colorPairs[Math.floor(Math.random() * colorPairs.length)];
            const color = pair[0];
            const glowColor = pair[1];
            item.style.color = color;
            item.style.textShadow = `0 0 10px ${glowColor}, 0 0 20px ${glowColor}, 0 0 30px ${color}`;

            // Prevent clipping: use larger buffer based on text length
            const itemWidth = (gameState.level >= 3) ? 250 : 150;
            const minX = 30;
            const maxX = Math.max(minX + 50, el.gameArea.offsetWidth - itemWidth - 30);
            item.style.left = (minX + Math.random() * (maxX - minX)) + 'px';
            item.style.top = '-100px';

            item.dataset.startTime = Date.now();
            item.dataset.duration = gameState.letterSpeed;

            el.gameArea.appendChild(item);
            gameState.activeItems.push(item);
        }

        function createMeteorite() {
            const item = document.createElement('div');
            item.className = 'meteorite gold-record';
            // Treasure Chest SVG - maritime Portuguese theme
            item.innerHTML = `<svg viewBox="0 0 50 50" width="50" height="50">
                <rect x="5" y="20" width="40" height="25" rx="3" fill="#8B4513"/>
                <rect x="7" y="22" width="36" height="21" rx="2" fill="#A0522D"/>
                <path d="M5 20 Q25 8 45 20" fill="#654321" stroke="#4a3728" stroke-width="1"/>
                <rect x="20" y="28" width="10" height="8" rx="1" fill="#FFD700"/>
                <circle cx="25" cy="32" r="2" fill="#1a1a2a"/>
                <line x1="8" y1="33" x2="42" y2="33" stroke="#654321" stroke-width="2"/>
                <rect x="10" y="15" width="30" height="3" fill="#FFD700"/>
            </svg>`;
            item.dataset.isMeteorite = 'true';

            // Prevent clipping
            const minX = 30;
            const maxX = Math.max(minX + 50, el.gameArea.offsetWidth - 100);
            item.style.left = (minX + Math.random() * (maxX - minX)) + 'px';
            item.style.top = '-80px';

            item.dataset.startTime = Date.now();
            item.dataset.duration = gameState.letterSpeed * 1.2; // Slightly slower

            el.gameArea.appendChild(item);
            gameState.activeItems.push(item);
        }

        function updateItems() {
            const h = el.gameArea.offsetHeight;
            const shipRect = el.spaceship.getBoundingClientRect();

            gameState.activeItems = gameState.activeItems.filter(item => {
                const elapsed = Date.now() - parseInt(item.dataset.startTime);
                const progress = elapsed / parseInt(item.dataset.duration);

                if (progress >= 1) {
                    item.remove();
                    return false;
                }

                item.style.top = (-70 + (h + 140) * progress) + 'px';

                // Only check collision for non-meteorite items that are near the bottom
                // AND only apply damage if touchHurts penalty is active
                if (item.dataset.isMeteorite !== 'true' && progress > 0.8 && gameState.touchHurts) {
                    // Use a tighter hitbox for fairer collision
                    const shipHitbox = {
                        left: shipRect.left + shipRect.width * 0.25,
                        right: shipRect.right - shipRect.width * 0.25,
                        top: shipRect.top + shipRect.height * 0.25,
                        bottom: shipRect.bottom - shipRect.height * 0.25
                    };
                    const itemRect = item.getBoundingClientRect();
                    const collision = !(itemRect.right < shipHitbox.left ||
                        itemRect.left > shipHitbox.right ||
                        itemRect.bottom < shipHitbox.top ||
                        itemRect.top > shipHitbox.bottom);

                    if (collision && !item.classList.contains('hit')) {
                        // Collided with ship - only hurts when penalty active
                        handleShipCollision(item);
                        return false;
                    }
                }

                return true;
            });
        }

        function handleShipCollision(item) {
            playSound('wrong');
            gameState.lives--;
            updateLives();

            const r = item.getBoundingClientRect();
            const cr = el.gameContainer.getBoundingClientRect();
            const x = r.left - cr.left + r.width / 2;
            const y = r.top - cr.top + r.height / 2;

            createExplosion(x, y, 'üí•');
            showFeedback('OUCH!', 'oops');
            item.remove();

            if (gameState.lives <= 0) {
                gameOverScreen();
            }
        }

        function moveShip(clientX) {
            const rect = el.gameContainer.getBoundingClientRect();
            const relX = clientX - rect.left;
            const w = rect.width;
            gameState.shipX = Math.max(25, Math.min(w - 25, relX));
            el.spaceship.style.left = gameState.shipX + 'px';
        }

        function shoot() {
            if (!gameState.isPlaying || gameState.isPaused || !gameState.canShoot) return;
            gameState.canShoot = false;
            setTimeout(() => gameState.canShoot = true, gameState.shootCooldown);

            playSound('blast');
            el.spaceship.classList.add('shooting');
            setTimeout(() => el.spaceship.classList.remove('shooting'), 100);
            el.shootHint.style.display = 'none';

            const laser = document.createElement('div');
            laser.className = 'laser';
            laser.style.left = (gameState.shipX - 4) + 'px';
            laser.style.bottom = '60px';
            el.gameContainer.appendChild(laser);
            gameState.activeLasers.push(laser);
        }

        function updateLasers() {
            const speed = 18;
            gameState.activeLasers = gameState.activeLasers.filter(laser => {
                const bot = parseFloat(laser.style.bottom) || 0;
                const newBot = bot + speed;
                if (newBot > el.gameContainer.offsetHeight) { laser.remove(); return false; }
                laser.style.bottom = newBot + 'px';

                const lr = laser.getBoundingClientRect();
                const lcx = lr.left + lr.width / 2;
                const lt = lr.top;

                for (let i = gameState.activeItems.length - 1; i >= 0; i--) {
                    const item = gameState.activeItems[i];
                    const ir = item.getBoundingClientRect();
                    if (lcx >= ir.left && lcx <= ir.right && lt <= ir.bottom && lt >= ir.top - 15) {
                        laser.remove();
                        handleHit(item, item.dataset.item);
                        return false;
                    }
                }
                return true;
            });
        }

        function handleHit(item, hitItemJson) {
            const r = item.getBoundingClientRect();
            const cr = el.gameContainer.getBoundingClientRect();
            const x = r.left - cr.left + r.width / 2;
            const y = r.top - cr.top + r.height / 2;
            gameState.activeItems = gameState.activeItems.filter(i => i !== item);

            // Check if it's a meteorite
            if (item.dataset.isMeteorite === 'true') {
                createExplosion(x, y, 'üí´');
                item.remove();
                showChallenge();
                return;
            }

            // Parse the hit item and compare
            const hitItem = JSON.parse(hitItemJson);
            const target = gameState.targetItem;

            // Compare based on level
            let isCorrect = false;
            if (gameState.level === 1) {
                // Level 1: Match sound character
                isCorrect = (hitItem.char === target.char);
            } else if (gameState.level === 2) {
                // Level 2: Word contains the target sound
                isCorrect = (hitItem.sound === target.sound);
            } else if (gameState.level === 3) {
                // Level 3: Hit the correct meaning (not false cognate)
                // If it's a false cognate, it's ALWAYS wrong
                if (hitItem.isFalseCognate) {
                    isCorrect = false;
                } else {
                    isCorrect = (hitItem.correct === target.correct);
                }
            } else if (gameState.level === 4) {
                // Level 4: Match Portuguese word to meaning
                isCorrect = (hitItem.word === target.word);
            }

            if (isCorrect) {
                playSound('correct');
                playSound('explosion'); // Add boom sound
                gameState.score += 100 * gameState.level;
                gameState.itemsCorrect++;
                el.scoreDisplay.textContent = gameState.score;
                item.classList.add('hit');
                createExplosion(x, y, 'üí•');
                showFeedback('GREAT!', 'great');
                setTimeout(() => item.remove(), 300);

                // Reset timer on correct answer
                resetTimer();

                if (gameState.itemsCorrect >= gameState.itemsPerRound) {
                    roundComplete();
                } else {
                    setNewTarget();
                }
            } else {
                playSound('wrong');
                gameState.lives--;
                updateLives();
                item.style.color = '#ff0000';
                item.classList.add('hit');
                createExplosion(x, y, 'üí®');

                if (gameState.level === 2) {
                    el.targetLetter.classList.remove('hidden-letter');
                    setTimeout(() => el.targetLetter.classList.add('hidden-letter'), 1200);
                }

                showFeedback('OUCH!', 'oops');
                const textToSpeak = target.word || target.char;
                setTimeout(() => speakItem(textToSpeak), 400);
                setTimeout(() => item.remove(), 300);

                if (gameState.lives <= 0) gameOverScreen();
            }
        }

        function createExplosion(x, y, emoji) {
            const exp = document.createElement('div');
            exp.className = 'explosion';
            exp.textContent = emoji;
            exp.style.left = (x - 20) + 'px';
            exp.style.top = (y - 20) + 'px';
            el.gameContainer.appendChild(exp);
            setTimeout(() => exp.remove(), 500);
        }

        function showFeedback(msg, type) {
            const fb = document.createElement('div');
            fb.className = `feedback ${type}`;
            fb.textContent = msg;
            el.gameContainer.appendChild(fb);
            setTimeout(() => fb.remove(), 1000);
        }

        function updateLives() {
            el.livesDisplay.innerHTML = '';
            for (let i = 0; i < gameState.lives; i++) {
                const life = document.createElement('span');
                life.className = 'life-icon';
                life.textContent = 'üêü';
                el.livesDisplay.appendChild(life);
            }
        }

        // Timer System
        function startTimer() {
            stopTimer();
            gameState.roundTimer = 15;
            el.timerSword.classList.remove('hidden');
            updateTimerDisplay();
            gameState.timerInterval = setInterval(tickTimer, 1000);
        }

        function stopTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            el.timerSword.classList.add('hidden');
        }

        function resetTimer() {
            gameState.roundTimer = 15;
            updateTimerDisplay();
        }

        function tickTimer() {
            if (gameState.isPaused || gameState.isInChallenge || !gameState.isPlaying) return;
            
            gameState.roundTimer--;
            updateTimerDisplay();
            
            // Sound effects for low time
            if (gameState.roundTimer <= 10 && gameState.roundTimer > 0) {
                playSound('timerTick');
            }
            
            // Time's up!
            if (gameState.roundTimer <= 0) {
                handleTimeout();
            }
        }

        function updateTimerDisplay() {
            const segments = document.querySelectorAll('#powerBar .power-segment');
            const timeDisplay = el.powerTime;
            const timePercent = gameState.roundTimer / 15;
            const activeSegments = Math.ceil(timePercent * 10);
            
            // Update segments
            segments.forEach((seg, i) => {
                seg.classList.remove('active', 'warning', 'critical');
                if (i < activeSegments) {
                    if (gameState.roundTimer <= 5) {
                        seg.classList.add('critical');
                    } else if (gameState.roundTimer <= 10) {
                        seg.classList.add('warning');
                    } else {
                        seg.classList.add('active');
                    }
                }
            });
            
            // Update time text
            timeDisplay.textContent = gameState.roundTimer + 's';
            timeDisplay.classList.remove('warning', 'critical');
            if (gameState.roundTimer <= 5) {
                timeDisplay.classList.add('critical');
            } else if (gameState.roundTimer <= 10) {
                timeDisplay.classList.add('warning');
            }
        }

        function handleTimeout() {
            gameState.timeoutCount++;
            playSound('timeout');
            
            if (gameState.timeoutCount === 1) {
                // 1st timeout: DANGER MODE - Touch hurts
                gameState.touchHurts = true;
                
                // Orange flash
                const flash = document.createElement('div');
                flash.className = 'timeout-flash danger';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 600);
                
                // DANGER MODE announcement
                showModeAnnouncement('‚ö†Ô∏è DANGER MODE ‚ö†Ô∏è', 'Targets now hurt!', 'danger');
                updatePenaltyIndicators();
                resetTimer();
                
            } else if (gameState.timeoutCount === 2) {
                // 2nd timeout: PANIC MODE - Speed increase
                gameState.speedPenalty = true;
                gameState.letterSpeed = gameState.baseLetterSpeed * 0.6; // 40% faster
                
                // Red flash
                const flash = document.createElement('div');
                flash.className = 'timeout-flash panic';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 600);
                
                // PANIC MODE announcement
                showModeAnnouncement('üî• PANIC MODE üî•', 'Speed increased!', 'panic');
                updatePenaltyIndicators();
                resetTimer();
                
            } else if (gameState.timeoutCount >= 3) {
                // 3rd timeout: GAME OVER
                const flash = document.createElement('div');
                flash.className = 'timeout-flash death';
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 800);
                
                showModeAnnouncement('üíÄ GAME OVER üíÄ', null, 'death');
                setTimeout(() => gameOverScreen(), 2000);
                return;
            }
        }

        function showModeAnnouncement(text, subtitle, mode) {
            const announce = document.createElement('div');
            announce.className = 'mode-announce ' + mode;
            announce.innerHTML = text + (subtitle ? `<div class="mode-subtitle">${subtitle}</div>` : '');
            el.gameContainer.appendChild(announce);
            setTimeout(() => announce.remove(), 2500);
        }

        function updatePenaltyIndicators() {
            el.penaltyIndicator.innerHTML = '';
            
            if (gameState.touchHurts) {
                const badge = document.createElement('div');
                badge.className = 'penalty-badge danger-mode';
                badge.textContent = '‚ö†Ô∏è DANGER';
                el.penaltyIndicator.appendChild(badge);
            }
            
            if (gameState.speedPenalty) {
                const badge = document.createElement('div');
                badge.className = 'penalty-badge panic-mode';
                badge.textContent = 'üî• PANIC';
                el.penaltyIndicator.appendChild(badge);
            }
        }

        function resetPenalties() {
            gameState.timeoutCount = 0;
            gameState.touchHurts = false;
            gameState.speedPenalty = false;
            gameState.letterSpeed = gameState.baseLetterSpeed;
            el.penaltyIndicator.innerHTML = '';
        }

        // Challenge System (Meteorite) - Multiple Choice
        function showChallenge() {
            gameState.isInChallenge = true;
            gameState.isDoubleDown = false;
            gameState.challengeFreezeTime = Date.now();

            // Freeze all items by storing their current elapsed time
            gameState.activeItems.forEach(item => {
                item.dataset.frozenElapsed = Date.now() - parseInt(item.dataset.startTime);
            });

            clearInterval(gameState.spawnInterval);
            stopMusic();
            if (gameState.externalAudio) gameState.externalAudio.pause();
            
            // Play challenge music if enabled
            if (gameState.challengeAudioEnabled) {
                playSound('challenge');
                const challengeMusic = document.getElementById('challengeMusic');
                console.log('Challenge music element:', challengeMusic);
                if (challengeMusic) {
                    console.log('Challenge music src:', challengeMusic.currentSrc || 'no source loaded');
                    challengeMusic.volume = gameState.challengeMusicVolume;
                    challengeMusic.currentTime = 0;
                    challengeMusic.play().then(() => {
                        console.log('Challenge music playing!');
                    }).catch(e => console.log('Challenge music blocked:', e));
                } else {
                    console.log('Challenge music element NOT found!');
                }
            }

            // Pick a random question
            const question = CHALLENGE_QUESTIONS[Math.floor(Math.random() * CHALLENGE_QUESTIONS.length)];
            gameState.currentChallenge = question;

            el.challengeQuestion.textContent = question.q;
            el.challengeResult.classList.add('hidden');
            el.doubleDownSection.classList.add('hidden');
            el.challengeContinueBtn.classList.add('hidden');

            // Create shuffled options
            const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
            el.challengeOptions.innerHTML = '';
            shuffledOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'challenge-option';
                btn.textContent = option;
                btn.addEventListener('click', () => selectChallengeOption(btn, option));
                el.challengeOptions.appendChild(btn);
            });

            el.challengeModal.classList.remove('hidden');
        }

        function selectChallengeOption(btn, selectedOption) {
            const correct = gameState.currentChallenge.a;
            const isCorrect = selectedOption === correct;

            // Disable all options
            const allOptions = el.challengeOptions.querySelectorAll('.challenge-option');
            allOptions.forEach(opt => {
                opt.classList.add('disabled');
                if (opt.textContent === correct) {
                    opt.classList.add('correct');
                }
            });

            if (isCorrect) {
                btn.classList.add('correct');
                playSound('powerup'); // Use powerup sound for gaining life
                if (gameState.lives < 5) {
                    gameState.lives++;
                    updateLives();
                }
                el.challengeResult.textContent = '+1 LIFE!';
                el.challengeResult.className = 'challenge-result correct';
                el.challengeResult.classList.remove('hidden');
                el.challengeContinueBtn.classList.remove('hidden');
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                el.challengeResult.textContent = `Correct answer: ${correct}`;
                el.challengeResult.className = 'challenge-result wrong';
                el.challengeResult.classList.remove('hidden');

                if (gameState.isDoubleDown) {
                    // Lost double down - lose a life
                    gameState.lives--;
                    updateLives();
                    el.challengeResult.textContent = `Wrong! -1 LIFE. Answer: ${correct}`;
                    el.challengeContinueBtn.classList.remove('hidden');
                    if (gameState.lives <= 0) {
                        setTimeout(() => {
                            el.challengeModal.classList.add('hidden');
                            gameOverScreen();
                        }, 1500);
                        return;
                    }
                } else {
                    // Show double down options
                    el.doubleDownSection.classList.remove('hidden');
                }
            }
        }

        function handleReturn() {
            // Safe return - no penalty, no reward
            closeChallenge();
        }

        function handleDoubleDown() {
            // Pick a new question for double down
            gameState.isDoubleDown = true;
            const question = CHALLENGE_QUESTIONS[Math.floor(Math.random() * CHALLENGE_QUESTIONS.length)];
            gameState.currentChallenge = question;

            el.challengeQuestion.textContent = question.q;
            el.challengeResult.classList.add('hidden');
            el.doubleDownSection.classList.add('hidden');
            el.challengeContinueBtn.classList.add('hidden');

            // Create shuffled options
            const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
            el.challengeOptions.innerHTML = '';
            shuffledOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'challenge-option';
                btn.textContent = option;
                btn.addEventListener('click', () => selectChallengeOption(btn, option));
                el.challengeOptions.appendChild(btn);
            });
        }

        function closeChallenge() {
            gameState.isInChallenge = false;
            el.challengeModal.classList.add('hidden');
            
            // Stop challenge music
            const challengeMusic = document.getElementById('challengeMusic');
            if (challengeMusic) {
                challengeMusic.pause();
            }

            // Resume items with adjusted timestamps
            const freezeDuration = Date.now() - gameState.challengeFreezeTime;
            gameState.activeItems.forEach(item => {
                const frozenElapsed = parseInt(item.dataset.frozenElapsed) || 0;
                item.dataset.startTime = Date.now() - frozenElapsed;
            });

            // Reset timer after challenge
            resetTimer();

            // Resume game with correct audio
            startSpawning();
            if (gameState.musicEnabled) {
                if (gameState.currentTrack === '8bit') {
                    startMusic();
                } else if (gameState.externalAudio) {
                    gameState.externalAudio.play();
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function roundComplete() {
            const config = LEVEL_CONFIG[gameState.level];
            
            // Check if there are more rounds in this level
            if (gameState.round < config.rounds) {
                // More rounds to go - show round announcement and continue
                nextRound();
            } else {
                // All rounds done - level complete
                levelComplete();
            }
        }

        function nextRound() {
            gameState.round++;
            gameState.itemsCorrect = 0;
            
            const config = LEVEL_CONFIG[gameState.level];
            
            // Increase speed for next round (round 2 = 20% faster, round 3 = 40% faster)
            const speedMultiplier = 1 - ((gameState.round - 1) * 0.2);
            gameState.letterSpeed = (config.baseSpeed || 10000) * speedMultiplier;
            
            // Refresh item pool (important for Level 4 vocab tiers)
            gameState.itemPool = getItemPool();
            
            // Update display
            el.roundDisplay.textContent = `${gameState.level}-${gameState.round}`;
            
            // Show round announcement with tier info for Level 4
            let subtitle = 'Speed increased!';
            if (gameState.level === 4) {
                const tierNames = ['', 'A1 Basics', 'A2 Travel', 'B1/B2 Advanced'];
                subtitle = tierNames[gameState.round] + ' - Speed increased!';
            }
            showRoundAnnouncement(gameState.round, subtitle);
            
            // Reset timer for new round
            resetTimer();
            
            // Continue with new target
            setNewTarget();
        }

        function showRoundAnnouncement(round, subtitle = 'Speed increased!') {
            const announce = document.createElement('div');
            announce.className = 'round-announce';
            announce.innerHTML = `üåä ROUND ${round}! üåä<div class="round-subtitle">${subtitle}</div>`;
            el.gameContainer.appendChild(announce);
            playSound('levelup');
            setTimeout(() => announce.remove(), 2000);
        }

        function levelComplete() {
            gameState.isPlaying = false;
            gameState.isDictationMode = false;
            stopMusic();
            stopTimer();
            clearInterval(gameState.spawnInterval);
            clearItems();

            // Hide dictation area if visible
            el.dictationArea.classList.add('hidden');
            el.spaceship.style.display = '';
            el.shootHint.style.display = '';

            if (gameState.level === 5) {
                // Game complete!
                playSound('win');
                saveGameResult(gameState.score, gameState.level);
                el.winScore.textContent = gameState.score;
                el.winStars.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.textContent = '‚≠ê';
                    star.style.animationDelay = (i * 0.2) + 's';
                    el.winStars.appendChild(star);
                }
                el.gameComplete.classList.remove('hidden');
                return;
            }

            playSound('levelup');

            const stars = Math.min(3, Math.ceil(gameState.lives));
            el.starsEarned.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const star = document.createElement('span');
                star.className = 'star';
                star.textContent = i < stars ? '‚≠ê' : '‚òÜ';
                star.style.animationDelay = (i * 0.2) + 's';
                el.starsEarned.appendChild(star);
            }

            const nextLevelNum = gameState.level + 1;
            const intros = {
                2: 'üìù <b>WORDS WITH SOUNDS!</b><br>Find words containing<br>the target sound!',
                3: '‚ö†Ô∏è <b>FALSE FRIENDS!</b><br>Shoot the TRUE meaning,<br>not the false cognate!',
                4: 'üéØ <b>VOCABULARY!</b><br>Match Portuguese words<br>to their meanings!',
                5: '‚úçÔ∏è <b>DICTATION!</b><br>Type the Portuguese word.<br>Example: ol√°'
            };

            el.levelCompleteTitle.textContent = `üéâ LEVEL ${gameState.level} DONE! üéâ`;
            el.levelCompleteText.textContent = `Get ready for Level ${nextLevelNum}!`;
            el.nextLevelIntro.innerHTML = intros[nextLevelNum];
            el.levelComplete.classList.remove('hidden');
        }

        function gameOverScreen() {
            gameState.isPlaying = false;
            stopMusic();
            stopTimer();
            clearInterval(gameState.spawnInterval);
            clearItems();
            saveGameResult(gameState.score, gameState.level);
            el.finalScore.textContent = gameState.score;
            el.gameOver.classList.remove('hidden');
        }

        function clearItems() {
            gameState.activeItems.forEach(i => i.remove());
            gameState.activeItems = [];
            gameState.activeLasers.forEach(l => l.remove());
            gameState.activeLasers = [];
        }

        function startGame() {
            initAudio();

            // Get selected starting level
            const selectedLevel = parseInt(el.levelSelect.value) || 1;
            const config = LEVEL_CONFIG[selectedLevel];

            gameState.score = 0;
            gameState.lives = 3;
            gameState.level = selectedLevel;
            gameState.round = 1;
            gameState.itemsPerRound = config.targetsPerRound;
            gameState.itemsCorrect = 0;
            gameState.itemPool = getItemPool();
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.canShoot = true;
            gameState.isDictationMode = false;
            gameState.baseLetterSpeed = config.baseSpeed || 10000;

            // Reset penalties and timer
            resetPenalties();

            el.scoreDisplay.textContent = '0';
            el.roundDisplay.textContent = `${selectedLevel}-${gameState.round}`;
            updateModeDisplay();
            updateLives();

            hideAllScreens();

            if (selectedLevel === 5) {
                // Start in dictation mode
                startDictationMode();
            } else {
                // Calculate speed based on round (round 2 = 20% faster, round 3 = 40% faster)
                const speedMultiplier = 1 - ((gameState.round - 1) * 0.2);
                gameState.letterSpeed = config.baseSpeed * speedMultiplier;
                gameState.spawnRate = config.spawnRate;

                el.spaceship.style.display = '';
                el.shootHint.style.display = 'block';
                el.dictationArea.classList.add('hidden');

                gameState.shipX = el.gameContainer.offsetWidth / 2;
                el.spaceship.style.left = gameState.shipX + 'px';

                setNewTarget();
                startSpawning();
                if (gameState.musicEnabled) {
                    if (gameState.currentTrack === '8bit') {
                        startMusic();
                    } else if (gameState.externalAudio) {
                        gameState.externalAudio.play().catch(e => {});
                    } else {
                        playExternalTrack(gameState.currentTrack);
                    }
                }
                startTimer();
                requestAnimationFrame(gameLoop);
            }
        }

        function nextLevel() {
            gameState.level++;
            gameState.round = 1; // Reset round for new level
            const config = LEVEL_CONFIG[gameState.level];

            gameState.itemsPerRound = config.targetsPerRound;
            gameState.itemsCorrect = 0;
            gameState.itemPool = getItemPool();
            gameState.isPlaying = true;
            gameState.baseLetterSpeed = config.baseSpeed || 10000;

            // Reset penalties for new level
            resetPenalties();

            el.roundDisplay.textContent = `${gameState.level}-${gameState.round}`;
            updateModeDisplay();
            el.levelComplete.classList.add('hidden');

            if (gameState.level === 5) {
                // Dictation mode
                startDictationMode();
            } else {
                // Calculate speed based on round (round 1 = base speed)
                gameState.letterSpeed = config.baseSpeed;
                gameState.spawnRate = config.spawnRate;
                gameState.isDictationMode = false;

                el.spaceship.style.display = '';
                el.shootHint.style.display = 'block';
                el.dictationArea.classList.add('hidden');

                setNewTarget();
                startSpawning();
                if (gameState.musicEnabled) {
                    if (gameState.currentTrack === '8bit') {
                        startMusic();
                    } else if (gameState.externalAudio) {
                        gameState.externalAudio.play().catch(e => {});
                    } else {
                        playExternalTrack(gameState.currentTrack);
                    }
                }
                startTimer();
                requestAnimationFrame(gameLoop);
            }
        }

        // Dictation Mode (Level 5)
        function startDictationMode() {
            gameState.isDictationMode = true;
            gameState.itemPool = [...DICTATION_WORDS];
            gameState.isPlaying = true;
            gameState.itemsPerRound = 10;
            gameState.itemsCorrect = 0;
            gameState.lives = 3;

            el.spaceship.style.display = 'none';
            el.shootHint.style.display = 'none';
            el.dictationArea.classList.remove('hidden');
            el.scoreDisplay.textContent = gameState.score;
            updateLives();
            updateModeDisplay();

            // Start timer for dictation mode
            startTimer();
            setDictationWord();
        }

        function setDictationWord() {
            const pool = gameState.itemPool;
            const target = pool[Math.floor(Math.random() * pool.length)];
            gameState.targetItem = target;

            // Show English word, user types Portuguese
            el.dictationPrompt.textContent = target.word;
            el.dictationInput.value = '';
            el.dictationInput.focus();
            
            // Reset timer for new word
            resetTimer();
            
            // Auto-speak the Portuguese answer so user can hear and spell it
            setTimeout(() => speakItem(target.pinyin, 'pt-PT'), 300);
        }

        function checkDictationAnswer() {
            const input = el.dictationInput.value.trim().toLowerCase();
            const target = gameState.targetItem;
            const correctAnswer = target.pinyin.toLowerCase();

            // Simple string match for Portuguese
            if (input === correctAnswer) {
                handleDictationSuccess();
                return;
            }

            // Failed
            playSound('wrong');
            gameState.lives--;
            updateLives();
            el.dictationInput.classList.add('shake');
            setTimeout(() => el.dictationInput.classList.remove('shake'), 500);

            // Show hint
            const hint = document.querySelector('.dictation-hint');
            hint.textContent = `Answer: ${target.pinyin}`;
            hint.style.color = 'var(--neon-orange)';
            setTimeout(() => {
                hint.textContent = 'Type the Portuguese word (e.g., hello ‚Üí ol√°)';
                hint.style.color = '';
            }, 2000);

            if (gameState.lives <= 0) {
                gameOverScreen();
            }
        }

        function handleDictationSuccess() {
            playSound('correct');
            gameState.score += 500;
            gameState.itemsCorrect++;
            el.scoreDisplay.textContent = gameState.score;
            createExplosion(window.innerWidth / 2, window.innerHeight / 2, '‚ú®');

            if (gameState.itemsCorrect >= 10) {
                roundComplete();
            } else {
                setDictationWord();
            }
        }

        function handleBeatsMe() {
            const target = gameState.targetItem;
            el.dictationInput.value = target.pinyin;
            el.dictationInput.focus();
        }

        function startSpawning() {
            if (gameState.spawnInterval) clearInterval(gameState.spawnInterval);
            gameState.spawnInterval = setInterval(createFloatingItem, gameState.spawnRate);
        }

        function gameLoop() {
            if (!gameState.isPlaying || gameState.isPaused) {
                if (gameState.isPlaying) requestAnimationFrame(gameLoop);
                return;
            }

            updateItems();
            updateLasers();

            if (gameState.isPlaying) requestAnimationFrame(gameLoop);
        }

        function pauseGame() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            gameState.isPaused = true;
            stopMusic();
            if (gameState.externalAudio) gameState.externalAudio.pause();
            el.pauseOverlay.classList.remove('hidden');
        }

        function resumeGame() {
            gameState.isPaused = false;
            el.pauseOverlay.classList.add('hidden');
            if (gameState.musicEnabled) {
                if (gameState.currentTrack === '8bit') {
                    startMusic();
                } else if (gameState.externalAudio) {
                    gameState.externalAudio.play();
                }
            }
        }

        function quitGame() {
            gameState.isPlaying = false;
            stopMusic();
            stopExternalAudio();
            stopTimer();
            clearInterval(gameState.spawnInterval);
            clearItems();

            el.pauseOverlay.classList.add('hidden');
            el.gameArea.classList.add('hidden');
            el.gameOver.classList.add('hidden');
            el.gameComplete.classList.add('hidden');
            el.dictationArea.classList.add('hidden'); // Safety

            el.titleScreen.classList.remove('hidden');

            // Save if we had a meaningful game
            if (gameState.score > 0) saveGameResult(gameState.score, gameState.level);
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            el.titleScreen.classList.add('hidden');
            el.loginScreen.classList.add('hidden');
            el.statsScreen.classList.add('hidden');
            el.scoreboardScreen.classList.add('hidden');

            el.gameArea.classList.remove('hidden');

        }

        function setupEventListeners() {
            // Login
            el.loginBtn.onclick = () => {
                const name = el.usernameInput.value.trim();
                if (!name) return alert('Name required!');
                gameState.currentUser = name;
                if (!gameData.players[name]) {
                    gameData.players[name] = { gamesPlayed: 0, bestScore: 0, history: [] };
                    saveData();
                }
                el.playerName.textContent = `Pilot: ${name}`;
                el.loginScreen.classList.add('hidden');
                el.titleScreen.classList.remove('hidden');
            };

            el.viewScoresBtn.onclick = () => {
                const list = el.scoreboardList;
                list.innerHTML = '';
                const scores = getTopScores();
                scores.forEach((s, i) => {
                    const li = document.createElement('li');
                    li.textContent = `#${i + 1} ${s.name}: ${s.score} pts (${s.games} games)`;
                    list.appendChild(li);
                });
                el.loginScreen.classList.add('hidden');
                el.scoreboardScreen.classList.remove('hidden');
            };

            el.importBtn.onclick = () => el.importFile.click();
            el.importFile.onchange = (e) => importData(e.target.files[0]);

            // Title Screen
            el.startBtn.onclick = startGame;

            el.statsBtn.onclick = () => {
                if (!gameState.currentUser) return;
                const p = gameData.players[gameState.currentUser];
                el.statsPlayerName.textContent = `Stats for ${gameState.currentUser}`;
                el.statsContainer.innerHTML = `
                    <p>Games Played: ${p.gamesPlayed}</p>
                    <p>Best Score: ${p.bestScore}</p>
                    <p>Last 5 Games:</p>
                    <ul>${p.history.slice(-5).map(h => `<li>Lvl ${h.level}: ${h.score} (${h.date})</li>`).join('')}</ul>
                `;
                el.titleScreen.classList.add('hidden');
                el.statsScreen.classList.remove('hidden');
            };

            el.scoresBtn.onclick = () => {
                const list = el.scoreboardList;
                list.innerHTML = '';
                const scores = getTopScores();
                scores.forEach((s, i) => {
                    const li = document.createElement('li');
                    li.textContent = `#${i + 1} ${s.name}: ${s.score} pts (${s.games} games)`;
                    list.appendChild(li);
                });
                el.titleScreen.classList.add('hidden');
                el.scoreboardScreen.classList.remove('hidden');
            };

            el.exportBtn.onclick = exportData;

            el.changeUserBtn.onclick = () => {
                el.titleScreen.classList.add('hidden');
                el.loginScreen.classList.remove('hidden');
            };

            // Back buttons
            el.statsBackBtn.onclick = () => {
                el.statsScreen.classList.add('hidden');
                el.titleScreen.classList.remove('hidden');
            };

            el.scoreboardBackBtn.onclick = () => {
                el.scoreboardScreen.classList.add('hidden');
                if (gameState.currentUser) {
                    el.titleScreen.classList.remove('hidden');
                } else {
                    el.loginScreen.classList.remove('hidden');
                }
            };

            // In Game
            el.pauseBtn.onclick = pauseGame;
            el.musicToggle.onclick = toggleMusic;
            el.playlistBtn.onclick = openPlaylist;
            el.playlistClose.onclick = closePlaylist;
            el.challengeMusicToggle.onclick = toggleChallengeAudio;
            
            // Volume sliders
            el.bgVolumeSlider.oninput = (e) => {
                gameState.bgMusicVolume = e.target.value / 100;
                if (gameState.externalAudio) {
                    gameState.externalAudio.volume = gameState.bgMusicVolume;
                }
                // Update mute button visual
                el.musicToggle.textContent = gameState.bgMusicVolume === 0 ? 'üîá' : 'üîä';
                el.musicToggle.classList.toggle('muted', gameState.bgMusicVolume === 0);
            };
            
            el.challengeVolumeSlider.oninput = (e) => {
                gameState.challengeMusicVolume = e.target.value / 100;
                const challengeMusic = document.getElementById('challengeMusic');
                if (challengeMusic) {
                    challengeMusic.volume = gameState.challengeMusicVolume;
                }
                // Update mute button visual
                el.challengeMusicToggle.textContent = gameState.challengeMusicVolume === 0 ? 'üîá' : 'üîä';
                el.challengeMusicToggle.classList.toggle('muted', gameState.challengeMusicVolume === 0);
            };
            
            // 8-bit track button in playlist
            document.querySelector('.playlist-track[data-track="8bit"]').onclick = () => selectTrack('8bit');
            
            el.speakBtn.onclick = () => {
                const target = gameState.targetItem;
                if (target) {
                    let text;
                    if (gameState.level === 1) {
                        // Level 1: speak the example word
                        text = target.example || target.char;
                    } else if (gameState.level === 2) {
                        // Level 2: speak the target word
                        text = target.word;
                    } else if (gameState.level === 5 || gameState.isDictationMode) {
                        // Dictation: speak the Portuguese answer
                        text = target.pinyin;
                    } else {
                        // Levels 3-4: speak the Portuguese word
                        text = target.word || target.char;
                    }
                    if (text) speakItem(text, 'pt-PT');
                }
            };

            el.gameContainer.addEventListener('mousemove', e => moveShip(e.clientX));
            el.gameContainer.addEventListener('click', (e) => {
                if (gameState.isDictationMode) return;
                if (e.target.tagName !== 'BUTTON') shoot();
            });

            document.addEventListener('keydown', e => {
                if (e.code === 'Space') {
                    if (!gameState.isDictationMode) shoot();
                }
                if (e.key === 'p') {
                    if (gameState.isPaused) resumeGame(); else pauseGame();
                }
            });

            // Pause & Game Over screens
            el.resumeBtn.onclick = resumeGame;
            el.quitBtn.onclick = quitGame;

            el.playAgainBtn.onclick = startGame;
            el.retryBtn.onclick = startGame;

            el.winMenuBtn.onclick = quitGame;
            el.gameOverMenuBtn.onclick = quitGame;

            el.continueBtn.onclick = nextLevel;

            // Dictation
            el.dictationSubmitBtn.onclick = checkDictationAnswer;
            el.beatsMeBtn.onclick = handleBeatsMe;
            el.dictationSpeakBtn.onclick = () => {
                const target = gameState.targetItem;
                if (target && target.pinyin) {
                    speakItem(target.pinyin, 'pt-PT');
                }
            };
            el.dictationInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') checkDictationAnswer();
            });

            // Challenge modal
            el.challengeContinueBtn.onclick = closeChallenge;
            el.returnBtn.onclick = handleReturn;
            el.doubleDownBtn.onclick = handleDoubleDown;
        }

        // Start
        init();

    </script>
</body>

</html>